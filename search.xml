<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Gemini CLI 配置指南</title>
      <link href="/2025/12/26/Gemini_CLI%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97/"/>
      <url>/2025/12/26/Gemini_CLI%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2><span id="gemini-cli-配置指南">Gemini CLI 配置指南</span></h2><blockquote><p>配置Gemini CLI，可在vscode中集成，提升开发效率。</p></blockquote><h2><span id="目录">目录</span></h2><p><a href="#%E5%9F%BA%E6%9C%AC%E8%A6%81%E6%B1%82">基本要求</a></p><p><a href="#%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4">配置步骤</a></p><p><a href="#VSCode%E9%9B%86%E6%88%90">VSCode集成</a></p><p><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">常用命令</a></p><p><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></p><hr><h2><span id="基本要求">基本要求</span></h2><ul><li><strong>科学上网</strong>：能够访问 Google 服务</li><li><strong>Google账号</strong>：用于登录和使用 Gemini</li><li><strong>Node.js</strong>：下载Gemini CLI</li></ul><hr><h2><span id="配置步骤">配置步骤</span></h2><h3><span id="step-1-安装-gemini-cli">Step 1: 安装 Gemini CLI</span></h3><p>全局安装 Gemini 命令行工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @google/gemini-cli</span><br></pre></td></tr></table></figure><h3><span id="step-2-验证安装">Step 2: 验证安装</span></h3><p>确认安装成功并检查版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gemini --version</span><br><span class="line"><span class="comment"># 正确安装将返回版本号，如: 1.2.3</span></span><br></pre></td></tr></table></figure><h3><span id="step-3-配置网络代理">Step 3: 配置网络代理</span></h3><p>由于 Gemini 需要访问 Google 服务，必须配置代理。</p><h4><span id="31-启动系统代理">3.1 启动系统代理</span></h4><p>确保你的代理工具（如 Clash、V2Ray 等）已启动并运行。</p><h4><span id="32-设置终端代理">3.2 设置终端代理</span></h4><p>**Windows (CMD/PowerShell)**：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMD</span></span><br><span class="line"><span class="built_in">set</span> http_proxy=http://<span class="number">127.0</span>.<span class="number">0.1</span>:xxxx</span><br><span class="line"><span class="built_in">set</span> https_proxy=http://<span class="number">127.0</span>.<span class="number">0.1</span>:xxxx</span><br><span class="line"></span><br><span class="line"><span class="comment"># PowerShell</span></span><br><span class="line"><span class="variable">$env:http_proxy</span>=<span class="string">&quot;http://127.0.0.1:xxxx&quot;</span></span><br><span class="line"><span class="variable">$env:https_proxy</span>=<span class="string">&quot;http://127.0.0.1:xxxx&quot;</span></span><br></pre></td></tr></table></figure><p><strong>Linux/macOS</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=http://127.0.0.1:xxxx</span><br><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:xxxx</span><br></pre></td></tr></table></figure><blockquote><p>⚠️ <strong>注意</strong>: 将 <code>xxxx</code> 替换为你的实际代理端口号</p></blockquote><h4><span id="33-验证代理配置">3.3 验证代理配置</span></h4><p>测试是否能访问 Google：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I https://www.google.com</span><br></pre></td></tr></table></figure><p><strong>成功输出示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html; charset=ISO-8859-1</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3><span id="step-4-首次登录">Step 4: 首次登录</span></h3><p>在配置好代理的终端中启动 Gemini：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gemini   # 终端输入</span><br></pre></td></tr></table></figure><h4><span id="41-选择登录方式">4.1 选择登录方式</span></h4><p>终端会显示登录选项，选择 **”Login with Google”**：</p><p><img src="gemini%E7%99%BB%E5%BD%95.png" alt="gemini登录"></p><h4><span id="42-浏览器授权">4.2 浏览器授权</span></h4><ul><li>Chrome 浏览器会自动打开 Google 登录页面</li><li>选择你的 Google 账号并授权</li><li>授权成功后返回终端</li></ul><h4><span id="43-登录成功">4.3 登录成功</span></h4><p>终端显示 Gemini CLI 交互界面：</p><p><img src="%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F.png" alt="登录成功"></p><h4><span id="44-选择模型"><strong>4.4 选择模型</strong></span></h4><p>终端右下角会显示选用Gemini的模型版本：</p><p><img src="%E6%A8%A1%E5%9E%8B%E7%89%88%E6%9C%AC.png"></p><p>若非最新版本，则启动gemini：</p><ul><li><p>输入<code>/settings</code>；</p><p><img src="settings.png" alt="settings界面"></p></li><li><p>通过回车切换，将<code>Preview Features</code>设置为<code>true</code>；</p></li><li><p>按<code>ESC</code>保存并回到命令行；</p></li><li><p>输入<code>/model</code>后会就可看到Gemini 3模型。</p><p><img src="gemini3%E6%A8%A1%E5%9E%8B.png" alt="模型选择界面"></p></li></ul><p>至此，Gemini CLI 基础配置完成！</p><hr><h2><span id="vscode集成"><strong>VSCode集成</strong></span></h2><p>在 VSCode 扩展市场中搜索并安装以下插件：</p><h4><span id="1-gemini-code-assist">1. Gemini Code Assist</span></h4><p><strong>功能特性</strong>：</p><ul><li> 智能代码补全和建议</li><li> 代码解释和文档生成</li><li> 错误诊断和修复建议</li><li> 代码重构和优化</li></ul><p><strong>安装方式</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VSCode 扩展商店 → 搜索 &quot;Gemini Code Assist&quot; → 安装</span><br></pre></td></tr></table></figure><p><strong>登录</strong>：与 CLI 登录方式相同</p><h4><span id="2-gemini-cli-companion">2. Gemini CLI Companion</span></h4><p><strong>功能特性</strong>：</p><ul><li><strong>上下文感知</strong>： 自动理解项目文件结构和代码逻辑</li><li><strong>减少重复操作</strong>：无需频繁复制粘贴代码</li><li><strong>项目级对话</strong>：在项目上下文中与 Gemini 对话</li><li><strong>精准问答</strong>：基于当前工作区的智能回答</li></ul><p><strong>安装方式</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VSCode 扩展商店 → 搜索 &quot;Gemini CLI Companion&quot; → 安装</span><br></pre></td></tr></table></figure><blockquote><p><strong>推荐</strong>: 两个插件配合使用，获得最佳体验</p></blockquote><hr><h2><span id="常用命令">常用命令</span></h2><h3><span id="终端命令">终端命令</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gemini --version          <span class="comment"># 查看版本</span></span><br><span class="line">gemini                    <span class="comment"># 启动 CLI</span></span><br></pre></td></tr></table></figure><h3><span id="cli-内部命令">CLI 内部命令</span></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/auth                     # 重新登录</span><br><span class="line">/model                    # 切换模型</span><br><span class="line">/stats                    # 查看使用量</span><br><span class="line">/clear                    # 清空对话</span><br><span class="line">/help                     # 显示帮助</span><br><span class="line">/exit                     # 退出</span><br></pre></td></tr></table></figure><h3><span id="代理配置">代理配置</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows</span></span><br><span class="line"><span class="built_in">set</span> http_proxy=http://127.0.0.1:7890</span><br><span class="line"><span class="built_in">set</span> https_proxy=http://127.0.0.1:7890</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS</span></span><br><span class="line"><span class="built_in">export</span> http_proxy=http://127.0.0.1:7890</span><br><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:7890</span><br></pre></td></tr></table></figure><hr><h2><span id="参考资料">参考资料</span></h2><ul><li><strong>Gemini API 文档</strong>: <a href="https://ai.google.dev/docs">https://ai.google.dev/docs</a></li><li><strong>Gemini CLI GitHub</strong>: <a href="https://github.com/google/gemini-cli">https://github.com/google/gemini-cli</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> AI Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gemini </tag>
            
            <tag> Gemini-cli </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pyinstaller打包记录--打包指南</title>
      <link href="/2025/06/08/Pyinstaller%E6%89%93%E5%8C%85%E8%AE%B0%E5%BD%95--%E6%89%93%E5%8C%85%E6%8C%87%E5%8D%97/"/>
      <url>/2025/06/08/Pyinstaller%E6%89%93%E5%8C%85%E8%AE%B0%E5%BD%95--%E6%89%93%E5%8C%85%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2><span id="pyinstaller打包指南">Pyinstaller打包指南</span></h2><blockquote><p>pyinstaller可将python程序打包成可执行文件，无需配置python环境，提升用户体验、便于分发。</p></blockquote><h2><span id="目录">目录</span></h2><p><a href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">快速开始</a></p><p><a href="#%E8%BF%9B%E9%98%B6%E9%85%8D%E7%BD%AE">进阶配置</a></p><p><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">常见问题</a></p><hr><h2><span id="快速开始">快速开始</span></h2><h3><span id="准备工作">准备工作</span></h3><p><strong>安装 PyInstaller</strong></p><p>打开终端（CMD 或 PowerShell），输入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyinstaller</span><br></pre></td></tr></table></figure><h3><span id="一键打包命令"><strong>一键打包命令</strong></span></h3><h4><span id="场景1简单脚本无外部资源">场景1：简单脚本（无外部资源）：</span></h4><p>适合只有一个 <code>.py</code> 文件，不依赖外部配置、图片、模型文件的程序。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller -F -w your_script.py   <span class="comment"># your_script.py 为需打包的脚本文件</span></span><br></pre></td></tr></table></figure><p><strong>参数说明：</strong></p><table><thead><tr><th>参数</th><th>全称</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>-F</code></td><td><code>--onefile</code></td><td>打包成单个 exe 文件</td><td>简单脚本，文件体积小</td></tr><tr><td><code>-w</code></td><td><code>--windowed</code></td><td>无控制台窗口</td><td>GUI 程序（PyQt5、Tkinter）</td></tr></tbody></table><p><strong>输出结果：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dist/</span><br><span class="line">└── your_script.exe  ← 可执行文件</span><br></pre></td></tr></table></figure><h4><span id="场景2包含资源文件的项目">场景2：包含资源文件的项目</span></h4><p>适合包含模型、配置文件、图片等资源的复杂项目。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller 主入口脚本.py \</span><br><span class="line">    --name=<span class="string">&quot;生成的软件名称&quot;</span> \</span><br><span class="line">    --onedir \</span><br><span class="line">    --add-data <span class="string">&quot;源文件路径;目标路径&quot;</span> \</span><br><span class="line">    --hidden-import=需手动导入的库名 \</span><br><span class="line">    --noconsole \</span><br><span class="line">    --clean \</span><br><span class="line">    -y</span><br></pre></td></tr></table></figure><p><strong>参数详解：</strong></p><table><thead><tr><th>参数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>--name</code></td><td>自定义输出名称</td><td><code>--name=&quot;检测程序&quot;</code></td></tr><tr><td><code>--onedir</code></td><td>文件夹模式（推荐）</td><td>生成 <code>MyApp/</code> 文件夹</td></tr><tr><td><code>--add-data</code></td><td>添加资源文件</td><td><code>&quot;源路径;目标路径&quot;</code></td></tr><tr><td><code>--hidden-import</code></td><td>强制导入模块</td><td>动态导入的库</td></tr><tr><td><code>--noconsole</code></td><td>隐藏控制台（同 <code>-w</code>）</td><td>GUI 程序使用</td></tr><tr><td><code>--clean</code></td><td>清理缓存</td><td>避免旧文件干扰</td></tr><tr><td><code>-y</code></td><td>自动确认覆盖</td><td>跳过提示</td></tr><tr><td><code>--runtime-tmpdir</code></td><td>指定临时文件解压位置</td><td>自定义运行时目录</td></tr><tr><td><code>--exclude-module</code></td><td>排除不需要的模块</td><td>减小体积</td></tr></tbody></table><p><strong>Windows 路径分隔符说明：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows 使用分号 ;</span></span><br><span class="line">--add-data <span class="string">&quot;models;models&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux/macOS 使用冒号 :</span></span><br><span class="line">--add-data <span class="string">&quot;models:models&quot;</span></span><br></pre></td></tr></table></figure><p><strong>完整示例（PyQt5 检测程序）：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller detection_app.py \</span><br><span class="line">    --name=<span class="string">&quot;智能检测系统&quot;</span> \</span><br><span class="line">    --onedir \</span><br><span class="line">    --add-data <span class="string">&quot;models;models&quot;</span> \</span><br><span class="line">    --add-data <span class="string">&quot;config;config&quot;</span> \</span><br><span class="line">    --add-data <span class="string">&quot;weights;weights&quot;</span> \</span><br><span class="line">    --add-data <span class="string">&quot;class_json;class_json&quot;</span> \</span><br><span class="line">    --hidden-import=PyQt5 \</span><br><span class="line">    --hidden-import=cv2 \</span><br><span class="line">    --hidden-import=torch \</span><br><span class="line">    --hidden-import=numpy \</span><br><span class="line">    --icon=<span class="string">&quot;logo.ico&quot;</span> \</span><br><span class="line">    --noconsole \</span><br><span class="line">    --clean \</span><br><span class="line">    -y</span><br></pre></td></tr></table></figure><p><strong>输出结果：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dist/</span><br><span class="line">└── 智能检测系统/</span><br><span class="line">    ├── 智能检测系统.exe  ← 主程序</span><br><span class="line">    └── _internal/         ← 依赖文件</span><br><span class="line">        ├── models/</span><br><span class="line">        ├── config/</span><br><span class="line">        ├── weights/</span><br><span class="line">        └── ...</span><br></pre></td></tr></table></figure><p>注意：至此，基本打包已完成！以下为复杂任务的打包进阶配置流程。</p><hr><h2><span id="进阶配置">进阶配置</span></h2><blockquote><p>对于包含模型文件、图片、配置文件或多个代码文件的复杂项目，推荐使用 <code>.spec</code> 配置文件进行打包。</p></blockquote><h3><span id="打包模式的选择">打包模式的选择</span></h3><p><strong>PyInstaller 有两种主要模式：</strong></p><ul><li>单文件模式 (-F)</li><li>文件夹模式 (-D) (默认)</li></ul><p><strong>模式对比：</strong></p><table><thead><tr><th>特性</th><th>文件夹模式 (-D)</th><th>单文件模式 (-F)</th></tr></thead><tbody><tr><td><strong>输出</strong></td><td>文件夹 + exe</td><td>单个 exe</td></tr><tr><td><strong>打包速度</strong></td><td>快（3-5分钟）</td><td>慢（10-30分钟）</td></tr><tr><td><strong>启动速度</strong></td><td>快（直接运行）</td><td>慢（需先解压）</td></tr><tr><td><strong>体积</strong></td><td>适中（150-500MB）</td><td>大（300MB-2GB）</td></tr><tr><td><strong>调试难度</strong></td><td>容易</td><td>困难</td></tr><tr><td><strong>兼容性</strong></td><td>好</td><td>一般</td></tr><tr><td><strong>分发</strong></td><td>需打包成 ZIP</td><td>单文件直接分发</td></tr><tr><td><strong>数据文件</strong></td><td>可单独更新</td><td>无法单独更新</td></tr><tr><td><strong>推荐度</strong></td><td>推荐</td><td>不推荐</td></tr></tbody></table><h3><span id="步骤-1-生成spec配置文件">步骤 1: 生成.spec配置文件</span></h3><p>在项目根目录下运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller your_script.py --name=<span class="string">&quot;MyProject&quot;</span></span><br></pre></td></tr></table></figure><p>运行后，会发现当前目录下多了一个 <code>MyProject.spec</code> 文件。</p><p><strong>可选参数：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller your_script.py \</span><br><span class="line">    --name=<span class="string">&quot;MyProject&quot;</span> \</span><br><span class="line">    --distpath ./dist \</span><br><span class="line">    --workpath ./build \</span><br><span class="line">    --specpath . \</span><br><span class="line">    -y</span><br></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>--distpath</code></td><td>指定输出目录（默认 <code>./dist</code>）</td></tr><tr><td><code>--workpath</code></td><td>指定构建缓存目录（默认 <code>./build</code>）</td></tr><tr><td><code>--specpath</code></td><td>指定 spec 文件保存位置（默认当前目录）</td></tr><tr><td><code>-y</code></td><td>自动覆盖已存在的文件</td></tr></tbody></table><hr><h3><span id="步骤-2-编辑-spec-文件">步骤 2: 编辑 .spec 文件</span></h3><p> 打开<code>MyProject.spec</code>，按需修改：</p><h4><span id="文件夹模式示例">文件夹模式示例：</span></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: python ; coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 1. 定义项目路径 ==========</span></span><br><span class="line">project_root = os.getcwd()  <span class="comment"># 当前目录</span></span><br><span class="line"><span class="comment"># 或者指定绝对路径：</span></span><br><span class="line"><span class="comment"># project_root = r&#x27;D:\my_projects\detection_app&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 2. Analysis 配置 ==========</span></span><br><span class="line">a = Analysis(</span><br><span class="line">    <span class="comment"># 主程序入口文件</span></span><br><span class="line">    [os.path.join(project_root, <span class="string">&#x27;main.py&#x27;</span>)],</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Python 搜索路径</span></span><br><span class="line">    pathex=[project_root],</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 二进制文件（通常为空）</span></span><br><span class="line">    binaries=[],</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 【关键】添加数据文件（左边=源路径，右边=打包后路径）</span></span><br><span class="line">    datas=[</span><br><span class="line">        (os.path.join(project_root, <span class="string">&#x27;models&#x27;</span>), <span class="string">&#x27;models&#x27;</span>),       <span class="comment"># 模型文件夹</span></span><br><span class="line">        (os.path.join(project_root, <span class="string">&#x27;config&#x27;</span>), <span class="string">&#x27;config&#x27;</span>),       <span class="comment"># 配置文件夹</span></span><br><span class="line">        (os.path.join(project_root, <span class="string">&#x27;weights&#x27;</span>), <span class="string">&#x27;weights&#x27;</span>),     <span class="comment"># 权重文件</span></span><br><span class="line">        (os.path.join(project_root, <span class="string">&#x27;images&#x27;</span>), <span class="string">&#x27;images&#x27;</span>),       <span class="comment"># 图片资源</span></span><br><span class="line">        (os.path.join(project_root, <span class="string">&#x27;fonts&#x27;</span>), <span class="string">&#x27;fonts&#x27;</span>),         <span class="comment"># 字体文件</span></span><br><span class="line">        <span class="comment"># 单个文件示例：</span></span><br><span class="line">        <span class="comment"># (os.path.join(project_root, &#x27;config.json&#x27;), &#x27;.&#x27;),     # 复制到根目录</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 【关键】隐藏导入（运行时报错 &quot;No module named xxx&quot; 时添加）</span></span><br><span class="line">    hiddenimports=[</span><br><span class="line">        <span class="string">&#x27;cv2&#x27;</span>,                    <span class="comment"># OpenCV</span></span><br><span class="line">        <span class="string">&#x27;PIL&#x27;</span>,                    <span class="comment"># Pillow</span></span><br><span class="line">        <span class="string">&#x27;PIL.Image&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;numpy&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;scipy&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;matplotlib&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pandas&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;torch&#x27;</span>,                  <span class="comment"># PyTorch</span></span><br><span class="line">        <span class="string">&#x27;torchvision&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PyQt5&#x27;</span>,                  <span class="comment"># PyQt5</span></span><br><span class="line">        <span class="string">&#x27;PyQt5.QtWidgets&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PyQt5.QtGui&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PyQt5.QtCore&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PyQt5.sip&#x27;</span>,</span><br><span class="line">        <span class="comment"># 根据实际情况添加</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 其他配置（通常保持默认）</span></span><br><span class="line">    hookspath=[],</span><br><span class="line">    hooksconfig=&#123;&#125;,</span><br><span class="line">    runtime_hooks=[],</span><br><span class="line">    excludes=[],                  <span class="comment"># 排除的模块</span></span><br><span class="line">    win_no_prefer_redirects=<span class="literal">False</span>,</span><br><span class="line">    win_private_assemblies=<span class="literal">False</span>,</span><br><span class="line">    cipher=<span class="literal">None</span>,</span><br><span class="line">    noarchive=<span class="literal">False</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 3. PYZ 配置（打包 Python 模块）==========</span></span><br><span class="line">pyz = PYZ(a.pure, a.zipped_data, cipher=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 4. EXE 配置（生成可执行文件）==========</span></span><br><span class="line">exe = EXE(</span><br><span class="line">    pyz,</span><br><span class="line">    a.scripts,</span><br><span class="line">    [],                           <span class="comment"># 空列表表示使用文件夹模式</span></span><br><span class="line">    exclude_binaries=<span class="literal">True</span>,        <span class="comment"># 【关键】排除二进制文件（文件夹模式）</span></span><br><span class="line">    name=<span class="string">&#x27;MyProject&#x27;</span>,             <span class="comment"># exe 文件名</span></span><br><span class="line">    debug=<span class="literal">False</span>,                  <span class="comment"># 调试模式（一般设为 False）</span></span><br><span class="line">    bootloader_ignore_signals=<span class="literal">False</span>,</span><br><span class="line">    strip=<span class="literal">False</span>,</span><br><span class="line">    upx=<span class="literal">True</span>,                     <span class="comment"># 使用 UPX 压缩（减小体积）</span></span><br><span class="line">    console=<span class="literal">True</span>,                 <span class="comment"># True=显示控制台，False=隐藏控制台</span></span><br><span class="line">    disable_windowed_traceback=<span class="literal">False</span>,</span><br><span class="line">    argv_emulation=<span class="literal">False</span>,</span><br><span class="line">    target_arch=<span class="literal">None</span>,</span><br><span class="line">    codesign_identity=<span class="literal">None</span>,</span><br><span class="line">    entitlements_file=<span class="literal">None</span>,</span><br><span class="line">    icon=<span class="string">&#x27;logo.ico&#x27;</span>,              <span class="comment"># 程序图标（.ico 格式）</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 5. COLLECT 配置（收集所有文件到文件夹）==========</span></span><br><span class="line">coll = COLLECT(</span><br><span class="line">    exe,</span><br><span class="line">    a.binaries,</span><br><span class="line">    a.zipfiles,</span><br><span class="line">    a.datas,</span><br><span class="line">    strip=<span class="literal">False</span>,</span><br><span class="line">    upx=<span class="literal">True</span>,</span><br><span class="line">    upx_exclude=[],</span><br><span class="line">    name=<span class="string">&#x27;MyProject&#x27;</span>,             <span class="comment"># 输出文件夹名称</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4><span id="单文件模式配置">单文件模式配置：</span></h4><p>如果坚持使用单文件模式，只需要修改EXE部分</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">exe = EXE(</span><br><span class="line">    pyz,</span><br><span class="line">    a.scripts,</span><br><span class="line">    a.binaries,         <span class="comment"># ← 添加</span></span><br><span class="line">    a.zipfiles,         <span class="comment"># ← 添加</span></span><br><span class="line">    a.datas,            <span class="comment"># ← 添加</span></span><br><span class="line">    [],</span><br><span class="line">    name=<span class="string">&#x27;MyProject&#x27;</span>,</span><br><span class="line">    debug=<span class="literal">False</span>,</span><br><span class="line">    bootloader_ignore_signals=<span class="literal">False</span>,</span><br><span class="line">    strip=<span class="literal">False</span>,</span><br><span class="line">    upx=<span class="literal">True</span>,</span><br><span class="line">    upx_exclude=[],</span><br><span class="line">    runtime_tmpdir=<span class="literal">None</span>,</span><br><span class="line">    console=<span class="literal">False</span>,</span><br><span class="line">    disable_windowed_traceback=<span class="literal">False</span>,</span><br><span class="line">    argv_emulation=<span class="literal">False</span>,</span><br><span class="line">    target_arch=<span class="literal">None</span>,</span><br><span class="line">    codesign_identity=<span class="literal">None</span>,</span><br><span class="line">    entitlements_file=<span class="literal">None</span>,</span><br><span class="line">    icon=<span class="string">&#x27;logo.ico&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：单文件模式不需要 COLLECT 部分，删除即可</span></span><br></pre></td></tr></table></figure><h3><span id="步骤-3-使用spec文件打包">步骤 3: 使用.spec文件打包</span></h3><p>编辑保存<code>.spec</code>后，运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller MyProject.spec --clean -y</span><br></pre></td></tr></table></figure><h4><span id="打包输出结构">打包输出结构：</span></h4><h5><span id="文件夹模式输出">文件夹模式输出：</span></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">your_project/</span><br><span class="line">├── MyProject.spec</span><br><span class="line">├── dist/</span><br><span class="line">│   └── MyProject/</span><br><span class="line">│       ├── MyProject.exe       ← 双击运行</span><br><span class="line">│       └── _internal/           ← 依赖文件</span><br><span class="line">│           ├── models/</span><br><span class="line">│           ├── config/</span><br><span class="line">│           ├── weights/</span><br><span class="line">│           ├── python310.dll</span><br><span class="line">│           ├── ...</span><br><span class="line">└── build/                       ← 临时构建文件（可删除）</span><br></pre></td></tr></table></figure><h5><span id="单文件模式输出">单文件模式输出：</span></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">your_project/</span><br><span class="line">├── MyProject.spec</span><br><span class="line">├── dist/</span><br><span class="line">│   └── MyProject.exe            ← 唯一文件</span><br><span class="line">└── build/                       ← 临时构建文件（可删除）</span><br></pre></td></tr></table></figure><hr><h2><span id="常见问题">常见问题</span></h2><h3><span id="问题-1-modulenotfounderror-no-module-named-xxx">问题 1: “ModuleNotFoundError: No module named ‘xxx’”</span></h3><p><strong>原因：</strong> 某个模块没有被 PyInstaller 自动检测到</p><p><strong>解决方案：</strong></p><p>在 <code>.spec</code> 文件的 hiddenimports 中添加缺失的模块名：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hiddenimports=[</span><br><span class="line">    <span class="string">&#x27;cv2&#x27;</span>,  <span class="comment"># 如果找不到cv2</span></span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3><span id="问题-2-数据文件未被包含如-weights-utils">问题 2: 数据文件未被包含（如 weights、utils）</span></h3><p><strong>原因：</strong> datas 配置不正确或路径错误。</p><p><strong>解决方案：</strong></p><p><strong>方法 1：检查 .spec 配置</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">datas=[</span><br><span class="line">    (<span class="string">&#x27;models&#x27;</span>, <span class="string">&#x27;models&#x27;</span>),        <span class="comment"># 确保源路径存在</span></span><br><span class="line">    (<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;config&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>方法 2：使用绝对路径</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">project_root = <span class="string">r&#x27;D:\projects\my_app&#x27;</span></span><br><span class="line"></span><br><span class="line">datas=[</span><br><span class="line">    (os.path.join(project_root, <span class="string">&#x27;models&#x27;</span>), <span class="string">&#x27;models&#x27;</span>),</span><br><span class="line">    (os.path.join(project_root, <span class="string">&#x27;config&#x27;</span>), <span class="string">&#x27;config&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>方法 3：检查打包后的文件</strong></p><p>在 <code>dist/MyApp/_internal/</code> 目录下，确认数据文件是否存在。</p><h3><span id="问题-3-exe-文件很大gt1gb">问题 3: exe 文件很大（&gt;1GB）</span></h3><p><strong>原因：</strong> 包含了过多的依赖库（如 torch、opencv）</p><p><strong>解决方案：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法1. 排除不必要的模块</span></span><br><span class="line">excluded=[</span><br><span class="line">    <span class="string">&#x27;matplotlib.backends.backend_tkagg&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;tkinter&#x27;</span>,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2. 过滤特定数据文件</span></span><br><span class="line"><span class="comment"># 在 Analysis 后添加</span></span><br><span class="line">a.datas = [d <span class="keyword">for</span> d <span class="keyword">in</span> a.datas <span class="keyword">if</span> <span class="keyword">not</span> d[<span class="number">0</span>].startswith(<span class="string">&#x27;matplotlib&#x27;</span>)]</span><br></pre></td></tr></table></figure><h3><span id="问题4打包时提示错误structerror-argument-out-of-range">问题4：打包时提示错误struct.error: argument out of range</span></h3><p><strong>原因：</strong>打包的文件总大小超过了 PyInstaller 的限制（单文件模式）。</p><p><strong>解决方案：</strong></p><p><strong>方法 1：使用文件夹模式</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 -F 改为 -D</span></span><br><span class="line">pyinstaller -D main.py</span><br></pre></td></tr></table></figure><p><strong>方法 2：精确指定需要的文件</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用绝对路径指定每个必需的文件</span></span><br><span class="line">datas=[</span><br><span class="line">    (<span class="string">r&#x27;D:\projects\app\models\yolov8.pt&#x27;</span>, <span class="string">&#x27;models&#x27;</span>),</span><br><span class="line">    (<span class="string">r&#x27;D:\projects\app\config\settings.json&#x27;</span>, <span class="string">&#x27;config&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>方法 3：分离大文件</strong></p><p>将大型模型文件放在程序外，运行时从外部加载：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不打包进 exe，运行时从外部加载</span></span><br><span class="line">model_path = <span class="string">&#x27;./models/yolov8.pt&#x27;</span>  <span class="comment"># 用户自己下载模型</span></span><br></pre></td></tr></table></figure><h3><span id="问题-5-程序运行时找不到数据文件">问题 5: 程序运行时找不到数据文件</span></h3><p><strong>原因：</strong> 代码中使用相对路径，打包后路径发生变化。</p><p><strong>解决方案：</strong></p><p>在代码中添加路径处理函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_resource_path</span>(<span class="params">relative_path</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取资源文件的正确路径&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">getattr</span>(sys, <span class="string">&#x27;frozen&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        <span class="comment"># 打包后运行</span></span><br><span class="line">        base_path = sys._MEIPASS  <span class="comment"># PyInstaller 临时目录</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 开发时运行</span></span><br><span class="line">        base_path = os.path.dirname(__file__)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os.path.join(base_path, relative_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用方法</span></span><br><span class="line">model_path = get_resource_path(<span class="string">&#x27;models/yolov8.pt&#x27;</span>)</span><br><span class="line">config_path = get_resource_path(<span class="string">&#x27;config/settings.json&#x27;</span>)</span><br></pre></td></tr></table></figure><p><strong>适用于各种文件类型：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型文件</span></span><br><span class="line">model = load_model(get_resource_path(<span class="string">&#x27;models/best.pt&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(get_resource_path(<span class="string">&#x27;config/config.json&#x27;</span>), <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    config = json.load(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 图片</span></span><br><span class="line">image = cv2.imread(get_resource_path(<span class="string">&#x27;images/logo.png&#x27;</span>))</span><br></pre></td></tr></table></figure><h3><span id="问题-6-打包后-pyqt5-窗口无法显示">问题 6: 打包后 PyQt5 窗口无法显示</span></h3><p><strong>原因：</strong> PyQt5 plugin 未被正确包含</p><p><strong>解决方案：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 spec 文件中确保添加了 PyQt5 相关的隐藏导入</span></span><br><span class="line">hiddenimports=[</span><br><span class="line">    <span class="string">&#x27;PyQt5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PyQt5.QtWidgets&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PyQt5.QtGui&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PyQt5.QtCore&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PyQt5.sip&#x27;</span>,</span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment"># 并添加 datas</span></span><br><span class="line">datas=[</span><br><span class="line">    <span class="comment"># ... 其他数据</span></span><br><span class="line">    (os.path.dirname(PyQt5.__file__), <span class="string">&#x27;PyQt5&#x27;</span>),</span><br><span class="line">],</span><br></pre></td></tr></table></figure><h3><span id="问题7windows打包后报错0007错误">问题7：windows打包后报错0007错误</span></h3><p><strong>原因：</strong>缺少 Visual C++ 运行库或系统驱动问题</p><p><strong>图例：</strong></p><p><img src="%E9%97%AE%E9%A2%987.png" alt="问题7"></p><p><strong>解决方案：</strong></p><p><strong>方法 1：安装 Visual C++ 运行库</strong></p><p>下载并安装：</p><ul><li><a href="https://aka.ms/vs/17/release/vc_redist.x64.exe">Microsoft Visual C++ Redistributable</a></li></ul><p><strong>方法 2：更新系统驱动</strong></p><ul><li>更新显卡驱动</li><li>更新 Windows 系统</li></ul><hr><h2><span id="版本历史">版本历史</span></h2><ul><li><strong>2025-06-08</strong>: 初始版本</li></ul>]]></content>
      
      
      <categories>
          
          <category> Engineering </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> PyInstaller </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GroundingDINO自定义数据微调指南</title>
      <link href="/2025/03/15/GroundingDINO%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BE%AE%E8%B0%83%E6%8C%87%E5%8D%97/"/>
      <url>/2025/03/15/GroundingDINO%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BE%AE%E8%B0%83%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2><span id="groundingdino自定义数据微调指南">GroundingDINO自定义数据微调指南</span></h2><blockquote><p>本文档介绍如何使用自己的数据微调GroundingDINO模型，使模型在保持文本泛化能力的同时，提升对目标的定位精度与稳定性。</p></blockquote><h2><span id="目录">目录：</span></h2><p><a href="#%E5%9F%BA%E6%9C%AC%E8%A6%81%E6%B1%82">基本要求</a></p><ul><li><a href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">环境配置</a></li><li><a href="#%E5%85%BC%E5%AE%B9%E6%80%A7%E9%AA%8C%E8%AF%81">兼容性验证</a></li><li><a href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96">安装依赖</a></li></ul><p><a href="#%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B">完整流程</a></p><ul><li><a href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87">数据准备</a></li><li><a href="#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">模型训练</a></li><li><a href="#%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86">模型推理</a></li></ul><p><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">常见问题</a></p><ul><li><a href="#%E5%AE%89%E8%A3%85%E9%97%AE%E9%A2%98">安装问题</a></li><li><a href="#%E8%AE%AD%E7%BB%83%E9%97%AE%E9%A2%98">训练问题</a></li></ul><p><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></p><hr><h2><span id="基本要求">基本要求</span></h2><ul><li><strong>开源仓库</strong>：<ul><li><a href="https://github.com/IDEA-Research/GroundingDINO">GroundingDINO</a></li><li><a href="https://github.com/longzw1997/Open-GroundingDino">open-GroundingDino</a></li></ul></li></ul><h3><span id="环境配置">环境配置</span></h3><ul><li><strong>Python版本</strong>：3.11.14</li><li><strong>操作系统</strong>：Windows/Linux</li><li><strong>CUDA版本</strong>：推荐11.8或更高</li><li><strong>编译软件</strong>：Microsoft visual studio（2017-2022）、visual c++ build tools &gt;= 14.0</li><li><strong>适配</strong>：CUDA-11.8适配VS&lt;2022，CUDA-12.8可适配VS2022</li></ul><h3><span id="兼容性验证">兼容性验证</span></h3><p>​    <strong>已测试可行环境</strong>：</p><ul><li>RTX 4060 + CUDA 11.8 + Python 3.11.14 + PyTorch 2.4.1+cu118</li><li>RTX 5090 + CUDA 12.8 + Python 3.12.0 + PyTorch 2.7.0+cu128</li></ul><h3><span id="安装依赖">安装依赖</span></h3><blockquote><p>已有conda环境</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda create -n 环境名 python==3.11.14  <span class="comment"># 创建新的conda环境, python为3.11.14</span></span><br></pre></td></tr></table></figure><p><strong>步骤1：安装PyTorch</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1 --index-url https://download.pytorch.org/whl/cu118</span><br></pre></td></tr></table></figure><p><strong>步骤2：安装GroundingDINO</strong></p><p>克隆open-GroundingDino和GroundingDINO仓库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># open-GroundingDino</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/longzw1997/Open-GroundingDino</span><br><span class="line"><span class="comment"># GroundingDINO</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/IDEA-Research/GroundingDINO</span><br></pre></td></tr></table></figure><p>将GroundingDINO源码解压到<code>open-GroundingDino</code>目录下，然后执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> GroundingDINO</span><br><span class="line"><span class="comment"># 编辑requirements.txt，注释掉torch和torchvision</span></span><br><span class="line">pip install -e .</span><br></pre></td></tr></table></figure><blockquote><p>⚠️ <strong>Windows用户注意事项</strong>：</p><ul><li>确认Visual Studio C++版本为2019（2022版本会报错）</li><li>GroundingDINO绝对路径不允许包含中文，否则会编译错误</li></ul></blockquote><p><strong>步骤3：安装setuptools</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install setuptools==69.5.1</span><br></pre></td></tr></table></figure><p><strong>步骤4：安装MultiScaleDeformableAttention模块</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Open-GroundingDino/models/GroundingDINO/ops</span><br><span class="line">python setup.py build install</span><br></pre></td></tr></table></figure><p><strong>步骤5：验证安装</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python test.py</span><br></pre></td></tr></table></figure><p>正确的输出应该包含以下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* True check_forward_equal_with_pytorch_double: max_abs_err 8.67e-19 max_rel_err 2.35e-16</span><br><span class="line">* True check_forward_equal_with_pytorch_float: max_abs_err 4.66e-10 max_rel_err 1.13e-07</span><br><span class="line">* True check_gradient_numerical(D=30)</span><br><span class="line">* True check_gradient_numerical(D=32)</span><br><span class="line">* True check_gradient_numerical(D=64)</span><br><span class="line">* True check_gradient_numerical(D=71)</span><br></pre></td></tr></table></figure><hr><h2><span id="完整流程">完整流程</span></h2><h3><span id="数据准备">数据准备</span></h3><h4><span id="步骤1准备训练数据odvg格式">步骤1：准备训练数据（ODVG格式）</span></h4><p>默认已使用labelImg标注得到xml格式的标签文件，使用 <code>voc2jsonl.py</code> 将XML标注文件转换为JSONL格式，保存为训练集文件<code>train.jsonl</code>。</p><p><strong>voc2jsonl.py</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> jsonlines</span><br><span class="line"><span class="keyword">from</span> xml.dom <span class="keyword">import</span> minidom</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">xml_dir, category_dict</span>):</span></span><br><span class="line">    metas = []</span><br><span class="line">    <span class="keyword">for</span> xml_path <span class="keyword">in</span> os.listdir(xml_dir):</span><br><span class="line">        <span class="comment"># jsonl_dict = &#123;&#125;</span></span><br><span class="line">        xml_path = os.path.join(xml_dir, xml_path)</span><br><span class="line">        tree = ET.parse(xml_path)</span><br><span class="line">        root = tree.getroot()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># regular</span></span><br><span class="line">        <span class="comment"># file_name = root.find(&#x27;filename&#x27;).text</span></span><br><span class="line">        <span class="comment"># unregular</span></span><br><span class="line">        file_name = <span class="built_in">str</span>(Path(root.find(<span class="string">&#x27;path&#x27;</span>).text).name)</span><br><span class="line"></span><br><span class="line">        file_name = file_name.replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;)&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;（&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;）&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        height = root.find(<span class="string">&#x27;size&#x27;</span>).find(<span class="string">&#x27;height&#x27;</span>).text</span><br><span class="line">        width = root.find(<span class="string">&#x27;size&#x27;</span>).find(<span class="string">&#x27;width&#x27;</span>).text</span><br><span class="line">        <span class="comment"># jsonl_dict[&quot;filename&quot;] = file_name</span></span><br><span class="line">        <span class="comment"># jsonl_dict[&quot;height&quot;] = height</span></span><br><span class="line">        <span class="comment"># jsonl_dict[&quot;width&quot;] = width</span></span><br><span class="line"></span><br><span class="line">        bboxes_l = []</span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> root.findall(<span class="string">&#x27;object&#x27;</span>):</span><br><span class="line">            cls_name = obj.find(<span class="string">&#x27;name&#x27;</span>).text</span><br><span class="line">            <span class="keyword">if</span> cls_name <span class="keyword">not</span> <span class="keyword">in</span> category_dict:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Warning: &#x27;<span class="subst">&#123;cls_name&#125;</span>&#x27; is not in the category dictionary.&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            label = category_dict[cls_name]</span><br><span class="line"></span><br><span class="line">            xmlbox = obj.find(<span class="string">&#x27;bndbox&#x27;</span>)</span><br><span class="line">            xmin = <span class="built_in">float</span>(xmlbox.find(<span class="string">&#x27;xmin&#x27;</span>).text)</span><br><span class="line">            xmax = <span class="built_in">float</span>(xmlbox.find(<span class="string">&#x27;xmax&#x27;</span>).text)</span><br><span class="line">            ymin = <span class="built_in">float</span>(xmlbox.find(<span class="string">&#x27;ymin&#x27;</span>).text)</span><br><span class="line">            ymax = <span class="built_in">float</span>(xmlbox.find(<span class="string">&#x27;ymax&#x27;</span>).text)</span><br><span class="line">            bboxes = [xmin, ymin, xmax, ymax]</span><br><span class="line">            bboxes_l.append(&#123;<span class="string">&quot;bbox&quot;</span>: bboxes, <span class="string">&quot;label&quot;</span>: label, <span class="string">&quot;category&quot;</span>: cls_name&#125;)</span><br><span class="line"></span><br><span class="line">        metas.append(</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;filename&quot;</span>: file_name,</span><br><span class="line">                <span class="string">&quot;height&quot;</span>: height,</span><br><span class="line">                <span class="string">&quot;width&quot;</span>: width,</span><br><span class="line">                <span class="string">&quot;detection&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;instances&quot;</span>: bboxes_l</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># jsonl_dict[&quot;detection&quot;][&quot;instances&quot;] = bboxes_l</span></span><br><span class="line">        <span class="comment"># metas.append(jsonl_dict)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> metas</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    xml_dir = <span class="string">&quot;xml dir path&quot;</span>  <span class="comment"># 修改为自己数据集的xml目标地址</span></span><br><span class="line">    jsonl_save_path = <span class="string">&quot;train.jsonl&quot;</span>  <span class="comment"># jsonl保存地址</span></span><br><span class="line">    category_dict = &#123;</span><br><span class="line">        <span class="string">&quot;pumpkin&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;taro&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;soybean&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;corn&quot;</span>: <span class="number">3</span></span><br><span class="line">    &#125;    <span class="comment"># 类别名及标签索引</span></span><br><span class="line">    metas = main(xml_dir, category_dict)</span><br><span class="line">    <span class="keyword">with</span> jsonlines.<span class="built_in">open</span>(jsonl_save_path, mode=<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> writer:</span><br><span class="line">        writer.write_all(metas)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;finish!&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>ODVG格式示例</strong>：<code>train.jsonl</code>（两张图片的标注）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;filename&quot;: &quot;IMG_20230306_110523.jpg&quot;, &quot;height&quot;: &quot;4096&quot;, &quot;width&quot;: &quot;3072&quot;, &quot;detection&quot;: &#123;&quot;instances&quot;: [&#123;&quot;bbox&quot;: [1059.0, 1498.0, 1289.0, 1720.0], &quot;label&quot;: &quot;0&quot;, &quot;category&quot;: &quot;cat&quot;&#125;, ...]&#125;&#125;</span><br><span class="line">&#123;&quot;filename&quot;: &quot;IMG_20230213_153518.jpg&quot;, &quot;height&quot;: &quot;4624&quot;, &quot;width&quot;: &quot;3472&quot;, &quot;detection&quot;: &#123;&quot;instances&quot;: [&#123;&quot;bbox&quot;: [879.0, 2701.0, 1302.0, 3131.0], &quot;label&quot;: &quot;0&quot;, &quot;category&quot;: &quot;cat&quot;&#125;, ...]&#125;&#125;</span><br></pre></td></tr></table></figure><h4><span id="步骤2准备验证数据coco格式">步骤2：准备验证数据（COCO格式）</span></h4><p>默认已使用labelImg标注得到xml格式的标签文件，使用 <code>voc2coco.py</code> 将验证数据xml转换为COCO格式的JSON文件（如 <code>val.json</code>）。</p><p><strong>voc2coco.py</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">功能说明：</span></span><br><span class="line"><span class="string">--------------------------------------------------</span></span><br><span class="line"><span class="string">本脚本用于将 Pascal VOC 格式的 XML 标注文件，</span></span><br><span class="line"><span class="string">转换为 COCO Detection（instances）格式的 JSON 文件。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VOC2COCOConverter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, categories</span>):</span></span><br><span class="line">        self.keep_categories = <span class="built_in">set</span>(categories)</span><br><span class="line"></span><br><span class="line">        self.coco = &#123;</span><br><span class="line">            <span class="string">&quot;info&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;VOC to COCO Dataset&quot;</span>,</span><br><span class="line">                <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;year&quot;</span>: datetime.now().year,</span><br><span class="line">                <span class="string">&quot;date_created&quot;</span>: datetime.now().strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;instances&quot;</span>,</span><br><span class="line">            <span class="string">&quot;images&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;annotations&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;categories&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        self.category_name_to_id = &#123;&#125;</span><br><span class="line">        self.image_name_set = <span class="built_in">set</span>()</span><br><span class="line">        self.next_category_id = <span class="number">0</span></span><br><span class="line">        self.next_image_id = <span class="number">0</span></span><br><span class="line">        self.next_annotation_id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ---------- Category ----------</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_add_category</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> self.category_name_to_id:</span><br><span class="line">            <span class="keyword">return</span> self.category_name_to_id[name]</span><br><span class="line"></span><br><span class="line">        cid = self.next_category_id</span><br><span class="line">        self.next_category_id += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        self.coco[<span class="string">&quot;categories&quot;</span>].append(&#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: cid,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">            <span class="string">&quot;supercategory&quot;</span>: <span class="string">&quot;none&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        self.category_name_to_id[name] = cid</span><br><span class="line">        <span class="keyword">return</span> cid</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ---------- Image ----------</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_add_image</span>(<span class="params">self, file_name, width, height</span>):</span></span><br><span class="line">        <span class="keyword">if</span> file_name <span class="keyword">in</span> self.image_name_set:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Duplicate image name: <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.next_image_id += <span class="number">1</span></span><br><span class="line">        self.image_name_set.add(file_name)</span><br><span class="line"></span><br><span class="line">        self.coco[<span class="string">&quot;images&quot;</span>].append(&#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: self.next_image_id,</span><br><span class="line">            <span class="string">&quot;file_name&quot;</span>: file_name,</span><br><span class="line">            <span class="string">&quot;width&quot;</span>: width,</span><br><span class="line">            <span class="string">&quot;height&quot;</span>: height,</span><br><span class="line">            <span class="string">&quot;date_captured&quot;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> self.next_image_id</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ---------- Annotation ----------</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_add_annotation</span>(<span class="params">self, image_id, category_id, bbox</span>):</span></span><br><span class="line">        x, y, w, h = bbox</span><br><span class="line">        segmentation = [[</span><br><span class="line">            x, y,</span><br><span class="line">            x, y + h,</span><br><span class="line">            x + w, y + h,</span><br><span class="line">            x + w, y</span><br><span class="line">        ]]</span><br><span class="line"></span><br><span class="line">        self.next_annotation_id += <span class="number">1</span></span><br><span class="line">        self.coco[<span class="string">&quot;annotations&quot;</span>].append(&#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: self.next_annotation_id,</span><br><span class="line">            <span class="string">&quot;image_id&quot;</span>: image_id,</span><br><span class="line">            <span class="string">&quot;category_id&quot;</span>: category_id,</span><br><span class="line">            <span class="string">&quot;bbox&quot;</span>: bbox,</span><br><span class="line">            <span class="string">&quot;area&quot;</span>: w * h,</span><br><span class="line">            <span class="string">&quot;iscrowd&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;segmentation&quot;</span>: segmentation</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ---------- XML ----------</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_xml</span>(<span class="params">self, xml_path</span>):</span></span><br><span class="line">        tree = ET.parse(xml_path)</span><br><span class="line">        root = tree.getroot()</span><br><span class="line"></span><br><span class="line">        file_node = root.find(<span class="string">&quot;path&quot;</span>) <span class="keyword">or</span> root.find(<span class="string">&quot;filename&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> file_node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;No filename/path in <span class="subst">&#123;xml_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        file_name = Path(file_node.text).name</span><br><span class="line">        file_name = file_name.translate(<span class="built_in">str</span>.maketrans(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;()（） &quot;</span>))</span><br><span class="line"></span><br><span class="line">        size = root.find(<span class="string">&quot;size&quot;</span>)</span><br><span class="line">        width = <span class="built_in">int</span>(size.findtext(<span class="string">&quot;width&quot;</span>))</span><br><span class="line">        height = <span class="built_in">int</span>(size.findtext(<span class="string">&quot;height&quot;</span>))</span><br><span class="line"></span><br><span class="line">        image_id = self._add_image(file_name, width, height)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> root.findall(<span class="string">&quot;object&quot;</span>):</span><br><span class="line">            name = obj.findtext(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.keep_categories:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            category_id = self._add_category(name)</span><br><span class="line"></span><br><span class="line">            box = obj.find(<span class="string">&quot;bndbox&quot;</span>)</span><br><span class="line">            xmin = <span class="built_in">int</span>(<span class="built_in">float</span>(box.findtext(<span class="string">&quot;xmin&quot;</span>)))</span><br><span class="line">            ymin = <span class="built_in">int</span>(<span class="built_in">float</span>(box.findtext(<span class="string">&quot;ymin&quot;</span>)))</span><br><span class="line">            xmax = <span class="built_in">int</span>(<span class="built_in">float</span>(box.findtext(<span class="string">&quot;xmax&quot;</span>)))</span><br><span class="line">            ymax = <span class="built_in">int</span>(<span class="built_in">float</span>(box.findtext(<span class="string">&quot;ymax&quot;</span>)))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> xmax &lt;= xmin <span class="keyword">or</span> ymax &lt;= ymin:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            bbox = [xmin, ymin, xmax - xmin, ymax - ymin]</span><br><span class="line">            self._add_annotation(image_id, category_id, bbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span>(<span class="params">self, json_path</span>):</span></span><br><span class="line">        os.makedirs(os.path.dirname(json_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(json_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(self.coco, f, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;✅ COCO json saved:&quot;</span>, json_path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Categories:&quot;</span>, <span class="built_in">len</span>(self.coco[<span class="string">&quot;categories&quot;</span>]))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Images:&quot;</span>, <span class="built_in">len</span>(self.coco[<span class="string">&quot;images&quot;</span>]))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Annotations:&quot;</span>, <span class="built_in">len</span>(self.coco[<span class="string">&quot;annotations&quot;</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==================================================</span></span><br><span class="line"><span class="comment"># CLI</span></span><br><span class="line"><span class="comment"># ==================================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_categories_from_file</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    parser = argparse.ArgumentParser(<span class="string">&quot;VOC XML → COCO JSON&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--voc-dir&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&quot;VOC XML 目录&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--save-path&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&quot;输出 COCO json 路径&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 🔹 类别参数（二选一）</span></span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--categories&quot;</span>,</span><br><span class="line">        nargs=<span class="string">&quot;+&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;类别列表，如：--categories corn soybean leaf&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--categories-file&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;类别文件，每行一个类别&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ---------- 类别解析 ----------</span></span><br><span class="line">    <span class="keyword">if</span> args.categories:</span><br><span class="line">        categories = args.categories</span><br><span class="line">    <span class="keyword">elif</span> args.categories_file:</span><br><span class="line">        categories = load_categories_from_file(args.categories_file)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;必须提供 --categories 或 --categories-file&quot;</span>)</span><br><span class="line"></span><br><span class="line">    converter = VOC2COCOConverter(categories)</span><br><span class="line"></span><br><span class="line">    xml_files = [</span><br><span class="line">        os.path.join(args.voc_dir, f)</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(args.voc_dir)</span><br><span class="line">        <span class="keyword">if</span> f.endswith(<span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(xml_files)&#125;</span> XML files&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Categories:&quot;</span>, categories)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> xml <span class="keyword">in</span> xml_files:</span><br><span class="line">        converter.parse_xml(xml)</span><br><span class="line"></span><br><span class="line">    converter.save(args.save_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br><span class="line"><span class="comment">#  使用说明</span></span><br><span class="line"><span class="comment"># python voc2coco.py --voc-dir /path/to/voc/xmls --save-path val.json --categories cat dog</span></span><br><span class="line"><span class="comment"># python voc2coco.py --voc-dir /path/to/voc/xmls --save-path val.json --categories-file classes.txt</span></span><br></pre></td></tr></table></figure><p><strong>COCO格式示例</strong>：<code>val.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;images&quot;</span>: [</span><br><span class="line">    &#123;<span class="attr">&quot;id&quot;</span>: <span class="number">1</span>, <span class="attr">&quot;file_name&quot;</span>: <span class="string">&quot;IMG_20241216_110229.jpg&quot;</span>, <span class="attr">&quot;width&quot;</span>: <span class="number">3072</span>, <span class="attr">&quot;height&quot;</span>: <span class="number">4096</span>, ...&#125;,</span><br><span class="line">    &#123;<span class="attr">&quot;id&quot;</span>: <span class="number">2</span>, <span class="attr">&quot;file_name&quot;</span>: <span class="string">&quot;IMG_20241217_161005.jpg&quot;</span>, <span class="attr">&quot;width&quot;</span>: <span class="number">3072</span>, <span class="attr">&quot;height&quot;</span>: <span class="number">4096</span>, ...&#125;,</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;instances&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;annotations&quot;</span>: [</span><br><span class="line">    &#123;<span class="attr">&quot;image_id&quot;</span>: <span class="number">1</span>, <span class="attr">&quot;bbox&quot;</span>: [<span class="number">550</span>, <span class="number">903</span>, <span class="number">173</span>, <span class="number">179</span>], <span class="attr">&quot;category_id&quot;</span>: <span class="number">0</span>, <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>, ...&#125;,</span><br><span class="line">    &#123;<span class="attr">&quot;image_id&quot;</span>: <span class="number">1</span>, <span class="attr">&quot;bbox&quot;</span>: [<span class="number">1396</span>, <span class="number">714</span>, <span class="number">224</span>, <span class="number">337</span>], <span class="attr">&quot;category_id&quot;</span>: <span class="number">0</span>, <span class="attr">&quot;id&quot;</span>: <span class="number">2</span>, ...&#125;,</span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;categories&quot;</span>: [</span><br><span class="line">    &#123;<span class="attr">&quot;supercategory&quot;</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">&quot;id&quot;</span>: <span class="number">0</span>, <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;cat&quot;</span>&#125;  # 将cat修改为自定义类别名</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="步骤3创建类别标签文件">步骤3：创建类别标签文件</span></h4><p>创建一个标签映射文件（如 <code>label.json</code>），用于记录类别ID和类别名称的对应关系。</p><p><strong>标签文件格式</strong>：<code>label.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;0&quot;</span>: <span class="string">&quot;cat&quot;</span>   # 将cat修改为自定义类别名</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="步骤4配置数据集路径">步骤4：配置数据集路径</span></h4><p>参考 <code>./config/datasets_od_example.json</code>，创建自定义数据配置文件<code>datasets_self.json</code>。</p><p><strong>配置文件格式</strong>：<code>datasets_self.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;train&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;root&quot;</span>: <span class="string">&quot;E://images&quot;</span>,                           <span class="comment">// 训练图片路径</span></span><br><span class="line">      <span class="attr">&quot;anno&quot;</span>: <span class="string">&quot;./train.jsonl&quot;</span>,                        <span class="comment">// 训练标注文件</span></span><br><span class="line">      <span class="attr">&quot;label_map&quot;</span>: <span class="string">&quot;./label.json&quot;</span>,                    <span class="comment">// 类别标签文件</span></span><br><span class="line">      <span class="attr">&quot;dataset_mode&quot;</span>: <span class="string">&quot;odvg&quot;</span>                          <span class="comment">// 数据格式：odvg</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;val&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;root&quot;</span>: <span class="string">&quot;E://images&quot;</span>,                           <span class="comment">// 验证图片路径</span></span><br><span class="line">      <span class="attr">&quot;anno&quot;</span>: <span class="string">&quot;./val.json&quot;</span>,                           <span class="comment">// 验证标注文件</span></span><br><span class="line">      <span class="attr">&quot;label_map&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">&quot;dataset_mode&quot;</span>: <span class="string">&quot;coco&quot;</span>                          <span class="comment">// 数据格式：coco</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3><span id="模型训练">模型训练</span></h3><h4><span id="步骤1修改训练配置文件">步骤1：修改训练配置文件</span></h4><p>参考 <code>./config/cfg_odvg.py</code> 文件，创建自定义配置文件<code>./config/cfg_odvg_self.py</code>，进行以下修改：</p><p><strong>修改1：设置类别文本提示</strong></p><p>在文件末尾添加：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前面不修改，复制cfg_odvg.py即可</span></span><br><span class="line"><span class="comment"># 最后一行添加</span></span><br><span class="line">label_list = [<span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>]  <span class="comment"># 设置文本提示词，根据自己的类别名修改</span></span><br></pre></td></tr></table></figure><h4><span id="步骤2下载预训练模型">步骤2：下载预训练模型</span></h4><p><strong>必需模型</strong>：</p><ol><li><strong>BERT预训练模型</strong>：下载 <a href="https://huggingface.co/google-bert/bert-base-uncased/tree/main"><code>bert-base-uncased</code></a>（用于文本编码）</li><li><strong>GroundingDINO权重</strong>：下载预训练权重文件，<a href="https://github.com/IDEA-Research/GroundingDINO/releases/download/v0.1.0-alpha/groundingdino_swint_ogc.pth"><code>groundingdino_swint_cogcoor.pth</code></a>、<a href="https://github.com/IDEA-Research/GroundingDINO/releases/download/v0.1.0-alpha2/groundingdino_swinb_cogcoor.pth"><code>Swin-Bgroundingdino_swinb_cogcoor.pth</code></a></li></ol><p><strong>修改2：选择Backbone（可选）</strong></p><p>如需使用 <code>groundingdino_swinb_cogcoor.pth</code> 预训练模型，修改backbone配置：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改前</span></span><br><span class="line">backbone = <span class="string">&#x27;swin_T_224_1k&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改后</span></span><br><span class="line">backbone = <span class="string">&#x27;swin_B_384_22k&#x27;</span></span><br></pre></td></tr></table></figure><h4><span id="步骤3启动训练">步骤3：启动训练</span></h4><p>修改 <code>train_mydata.sh</code> 中的数据路径参数：</p><p> <code>train_mydata.sh</code> 代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python main.py  \</span><br><span class="line">    --output_dir  ./output/ \</span><br><span class="line">    -c  config/cfg_odvg_self.py      \</span><br><span class="line">    --datasets  config/datasets_self.json   \</span><br><span class="line">    --pretrain_model_path  ./weights/groundingdino_swinb_cogcoor.pth   \</span><br><span class="line">    --options  text_encoder_type=bert-base-uncased  \</span><br><span class="line">    --amp</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash train_mydata.sh</span><br></pre></td></tr></table></figure><p>或直接在终端执行脚本中的命令。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python main.py --output_dir  ./output/ -c  config/cfg_odvg_self.py --datasets  ./config/datasets_self.json --pretrain_model_path  ./weights/groundingdino_swinb_cogcoor.pth --options  text_encoder_type=bert-base-uncased --amp</span><br></pre></td></tr></table></figure><hr><h2><span id="模型推理">模型推理</span></h2><h3><span id="推理使用">推理使用</span></h3><p><strong>步骤1：主目录下新建一个<code>dino_conf.yaml</code>文件</strong>，代码如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># GroundingDINO 模型配置</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="attr">model:</span></span><br><span class="line">  <span class="comment"># -------------------------</span></span><br><span class="line">  <span class="comment"># 模型结构配置文件</span></span><br><span class="line">  <span class="comment"># ⚠️ 必须修改为你本地的 GroundingDINO 配置</span></span><br><span class="line">  <span class="attr">config_file:</span> <span class="string">./tools/GroundingDINO_SwinB_cfg.py</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># -------------------------</span></span><br><span class="line">  <span class="comment"># 模型权重路径</span></span><br><span class="line">  <span class="comment"># ⚠️ 必须修改为你本地训练好的或官方权重</span></span><br><span class="line">  <span class="attr">checkpoint_path:</span> <span class="string">./weights/groundingdino_swinb_cogcoor.pth</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># -------------------------</span></span><br><span class="line">  <span class="comment"># 是否只使用 CPU 推理</span></span><br><span class="line">  <span class="comment"># True 仅使用 CPU，False 使用 GPU</span></span><br><span class="line">  <span class="attr">cpu_only:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># 推理参数</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="attr">inference:</span></span><br><span class="line">  <span class="comment"># -------------------------</span></span><br><span class="line">  <span class="comment"># 框置信度阈值</span></span><br><span class="line">  <span class="attr">box_threshold:</span> <span class="number">0.3</span>   <span class="comment"># [0~1]，越大输出框越严格</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># -------------------------</span></span><br><span class="line">  <span class="comment"># 文本 token 匹配阈值</span></span><br><span class="line">  <span class="attr">text_threshold:</span> <span class="number">0.25</span>  <span class="comment"># [0~1]，越大匹配越严格</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># -------------------------</span></span><br><span class="line">  <span class="comment"># 精确短语模式，可为 null 或 [[(start,end), ...]]</span></span><br><span class="line">  <span class="comment"># 一般不改为 null 即可</span></span><br><span class="line">  <span class="attr">token_spans:</span> <span class="literal">null</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>步骤2：主目录下新建<code>infer_dino.py</code>并编辑，修改以下参数：</strong></p><ul><li><strong>cfg_path</strong>：配置文件</li><li><strong>image_dir</strong>：待推理图片目录路径</li><li>**save_dir  **：结果保存目录路径</li><li><strong>text_prompt</strong> ：文本提示词</li></ul><p><strong>infer_dino.py</strong>：代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">推理并可视化</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont, ImageFile</span><br><span class="line">ImageFile.LOAD_TRUNCATED_IMAGES = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GroundingDINO（确保 GroundingDINO 已正确安装）</span></span><br><span class="line"><span class="keyword">import</span> groundingdino.groundingdino.datasets.transforms <span class="keyword">as</span> T</span><br><span class="line"><span class="keyword">from</span> groundingdino.groundingdino.models <span class="keyword">import</span> build_model</span><br><span class="line"><span class="keyword">from</span> groundingdino.groundingdino.util.slconfig <span class="keyword">import</span> SLConfig</span><br><span class="line"><span class="keyword">from</span> groundingdino.groundingdino.util.utils <span class="keyword">import</span> (</span><br><span class="line">    clean_state_dict,</span><br><span class="line">    get_phrases_from_posmap,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> groundingdino.groundingdino.util.vl_utils <span class="keyword">import</span> (</span><br><span class="line">    create_positive_map_from_span,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># Config</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_config</span>(<span class="params">cfg_path</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    读取 yaml 配置文件</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(cfg_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> yaml.safe_load(f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># Image</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_image</span>(<span class="params">image_path</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    加载并预处理单张图片</span></span><br><span class="line"><span class="string">    ⚠️一般不需要修改</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image_pil = Image.<span class="built_in">open</span>(image_path).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line"></span><br><span class="line">    transform = T.Compose([</span><br><span class="line">        T.RandomResize([<span class="number">800</span>], max_size=<span class="number">1333</span>),   <span class="comment"># ← 若显存不足，可调小 800</span></span><br><span class="line">        T.ToTensor(),</span><br><span class="line">        T.Normalize(</span><br><span class="line">            [<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>],</span><br><span class="line">            [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>],</span><br><span class="line">        ),</span><br><span class="line">    ])</span><br><span class="line">    image, _ = transform(image_pil, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> image_pil, image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># Model</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_dino_model</span>(<span class="params">cfg</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    构建 GroundingDINO 模型</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ===== 【需要修改】是否只用 CPU =====</span></span><br><span class="line">    device = <span class="string">&quot;cpu&quot;</span> <span class="keyword">if</span> cfg.get(<span class="string">&quot;cpu_only&quot;</span>, <span class="literal">False</span>) <span class="keyword">else</span> <span class="string">&quot;cuda&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【通常不需要修改】模型结构配置 =====</span></span><br><span class="line">    args = SLConfig.fromfile(cfg[<span class="string">&quot;config_file&quot;</span>])</span><br><span class="line">    args.device = device</span><br><span class="line"></span><br><span class="line">    model = build_model(args)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【需要修改】模型权重路径 =====</span></span><br><span class="line">    checkpoint = torch.load(cfg[<span class="string">&quot;checkpoint_path&quot;</span>], map_location=<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">    model.load_state_dict(</span><br><span class="line">        clean_state_dict(checkpoint[<span class="string">&quot;model&quot;</span>]),</span><br><span class="line">        strict=<span class="literal">False</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    model.to(device)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model, device</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># Inference</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">groundingdino_infer</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    model,</span></span></span><br><span class="line"><span class="params"><span class="function">    image,</span></span></span><br><span class="line"><span class="params"><span class="function">    text_prompt,</span></span></span><br><span class="line"><span class="params"><span class="function">    box_threshold,</span></span></span><br><span class="line"><span class="params"><span class="function">    text_threshold,</span></span></span><br><span class="line"><span class="params"><span class="function">    device=<span class="string">&quot;cuda&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    token_spans=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    with_logits=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    单张图片推理</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ===== 【需要修改】检测目标文本 =====</span></span><br><span class="line">    caption = text_prompt.lower().strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> caption.endswith(<span class="string">&quot;.&quot;</span>):</span><br><span class="line">        caption += <span class="string">&quot;.&quot;</span></span><br><span class="line"></span><br><span class="line">    image = image.to(device)</span><br><span class="line">    outputs = model(image[<span class="literal">None</span>], captions=[caption])</span><br><span class="line"></span><br><span class="line">    logits = outputs[<span class="string">&quot;pred_logits&quot;</span>].sigmoid()[<span class="number">0</span>]</span><br><span class="line">    boxes = outputs[<span class="string">&quot;pred_boxes&quot;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【需要修改】box 置信度阈值 =====</span></span><br><span class="line">    logits_filt = logits.cpu()</span><br><span class="line">    boxes_filt = boxes.cpu()</span><br><span class="line">    mask = logits_filt.<span class="built_in">max</span>(dim=<span class="number">1</span>)[<span class="number">0</span>] &gt; box_threshold</span><br><span class="line"></span><br><span class="line">    logits_filt = logits_filt[mask]</span><br><span class="line">    boxes_filt = boxes_filt[mask]</span><br><span class="line"></span><br><span class="line">    tokenizer = model.tokenizer</span><br><span class="line">    tokenized = tokenizer(caption)</span><br><span class="line"></span><br><span class="line">    phrases = []</span><br><span class="line">    <span class="keyword">for</span> logit <span class="keyword">in</span> logits_filt:</span><br><span class="line">        phrase = get_phrases_from_posmap(</span><br><span class="line">            logit &gt; text_threshold,   <span class="comment"># ← 【需要修改】文本 token 阈值</span></span><br><span class="line">            tokenized,</span><br><span class="line">            tokenizer,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> with_logits:</span><br><span class="line">            phrase += <span class="string">f&quot;(<span class="subst">&#123;logit.<span class="built_in">max</span>().item():<span class="number">.3</span>f&#125;</span>)&quot;</span></span><br><span class="line">        phrases.append(phrase)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> boxes_filt, phrases</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># Box utils</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cxcywh_to_xyxy</span>(<span class="params">boxes, image_size</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    模型输出 box 格式转换为像素级 xyxy</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    H, W = image_size</span><br><span class="line">    boxes = boxes * torch.tensor([W, H, W, H])</span><br><span class="line"></span><br><span class="line">    xyxy = boxes.clone()</span><br><span class="line">    xyxy[:, :<span class="number">2</span>] -= xyxy[:, <span class="number">2</span>:] / <span class="number">2</span></span><br><span class="line">    xyxy[:, <span class="number">2</span>:] += xyxy[:, :<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> xyxy.<span class="built_in">int</span>().tolist()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># Visualization</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visualize_and_save</span>(<span class="params">image_pil, boxes, phrases, save_path</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    可视化并保存检测结果</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    draw = ImageDraw.Draw(image_pil, <span class="string">&quot;RGBA&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【可选修改】字体大小 / 字体路径 =====</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        font = ImageFont.truetype(<span class="string">&quot;SimHei.ttf&quot;</span>, <span class="number">32</span>)</span><br><span class="line">    <span class="keyword">except</span> IOError:</span><br><span class="line">        font = ImageFont.load_default()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> phrase, box <span class="keyword">in</span> <span class="built_in">zip</span>(phrases, boxes):</span><br><span class="line">        color = <span class="built_in">tuple</span>(np.random.randint(<span class="number">0</span>, <span class="number">255</span>, size=<span class="number">3</span>).tolist())</span><br><span class="line">        x0, y0, x1, y1 = box</span><br><span class="line"></span><br><span class="line">        draw.rectangle([x0, y0, x1, y1], outline=color, width=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(draw, <span class="string">&quot;textbbox&quot;</span>):</span><br><span class="line">            tb = draw.textbbox((x0, y0), phrase, font=font)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            w, h = draw.textsize(phrase, font=font)</span><br><span class="line">            tb = (x0, y0, x0 + w, y0 + h)</span><br><span class="line"></span><br><span class="line">        draw.rectangle(tb, fill=color + (<span class="number">160</span>,))</span><br><span class="line">        draw.text((x0, y0), phrase, fill=(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>), font=font)</span><br><span class="line"></span><br><span class="line">    os.makedirs(os.path.dirname(save_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    image_pil.save(save_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># Batch inference</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">batch_infer</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    image_dir,</span></span></span><br><span class="line"><span class="params"><span class="function">    save_dir,</span></span></span><br><span class="line"><span class="params"><span class="function">    model,</span></span></span><br><span class="line"><span class="params"><span class="function">    device,</span></span></span><br><span class="line"><span class="params"><span class="function">    cfg,</span></span></span><br><span class="line"><span class="params"><span class="function">    text_prompt,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    批量目录推理</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    os.makedirs(save_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【需要修改】支持的图片格式 =====</span></span><br><span class="line">    image_files = [</span><br><span class="line">        f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(image_dir)</span><br><span class="line">        <span class="keyword">if</span> f.lower().endswith((<span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.bmp&quot;</span>, <span class="string">&quot;.tif&quot;</span>))</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(image_files)&#125;</span> images&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> idx, img_name <span class="keyword">in</span> <span class="built_in">enumerate</span>(image_files):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;idx+<span class="number">1</span>&#125;</span>/<span class="subst">&#123;<span class="built_in">len</span>(image_files)&#125;</span>] Processing <span class="subst">&#123;img_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        img_path = os.path.join(image_dir, img_name)</span><br><span class="line">        image_pil, image = load_image(img_path)</span><br><span class="line"></span><br><span class="line">        H, W = image_pil.size[<span class="number">1</span>], image_pil.size[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        boxes, phrases = groundingdino_infer(</span><br><span class="line">            model=model,</span><br><span class="line">            image=image,</span><br><span class="line">            text_prompt=text_prompt,</span><br><span class="line">            box_threshold=cfg[<span class="string">&quot;box_threshold&quot;</span>],   <span class="comment"># ← 来自 yaml</span></span><br><span class="line">            text_threshold=cfg[<span class="string">&quot;text_threshold&quot;</span>], <span class="comment"># ← 来自 yaml</span></span><br><span class="line">            device=device,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(boxes) == <span class="number">0</span>:</span><br><span class="line">            image_pil.save(os.path.join(save_dir, img_name))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        boxes_xyxy = cxcywh_to_xyxy(boxes, (H, W))</span><br><span class="line">        save_path = os.path.join(save_dir, img_name)</span><br><span class="line"></span><br><span class="line">        visualize_and_save(image_pil, boxes_xyxy, phrases, save_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="comment"># Main</span></span><br><span class="line"><span class="comment"># =================================================</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【必须修改】配置文件路径 =====</span></span><br><span class="line">    cfg_path = <span class="string">&quot;./dino_conf.yaml&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【必须修改】输入图片目录 =====</span></span><br><span class="line">    image_dir = <span class="string">&quot;./test_images&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【必须修改】可视化结果保存目录 =====</span></span><br><span class="line">    save_dir = <span class="string">&quot;./vis_results&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ===== 【必须修改】检测目标文本（prompt） =====</span></span><br><span class="line">    text_prompt = <span class="string">&quot;cat&quot;</span></span><br><span class="line"></span><br><span class="line">    cfg = load_config(cfg_path)</span><br><span class="line"></span><br><span class="line">    model, device = build_dino_model(cfg)</span><br><span class="line"></span><br><span class="line">    batch_infer(</span><br><span class="line">        image_dir=image_dir,</span><br><span class="line">        save_dir=save_dir,</span><br><span class="line">        model=model,</span><br><span class="line">        device=device,</span><br><span class="line">        cfg=cfg,</span><br><span class="line">        text_prompt=text_prompt,</span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>步骤3：运行推理</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python infer_dino.py</span><br></pre></td></tr></table></figure><p><strong>多类别提示词使用</strong>：</p><p>如需检测多个类别，使用 <code>.</code> 分隔提示词，例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text_prompt = <span class="string">&quot;dog. cat. pig.&quot;</span></span><br></pre></td></tr></table></figure><hr><h2><span id="常见问题">常见问题</span></h2><h3><span id="安装问题">安装问题</span></h3><h4><span id="q1cuda-122版本编译错误">Q1：CUDA 12.2+版本编译错误</span></h4><p><strong>问题描述</strong>：使用CUDA 12.2及更高版本编译时，显示构建<code>ms_deform_attn_cuda.cu</code>文件报错，或提示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no suitable conversion function from &#x27;const at::DeprecatedTypeProperties&#x27; to &#x27;c10::ScalarType&#x27; exists</span><br></pre></td></tr></table></figure><p><strong>解决方案</strong>：</p><p>修改文件：<code>GroundingDINO/groundingdino/models/GroundingDINO/csrc/MsDeformAttn/ms_deform_attn_cuda.cu</code></p><p>在第65行和第135行，将 <code>value.type()</code> 替换为 <code>value.scalar_type()</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 修改前</span><br><span class="line"><span class="built_in">AT_DISPATCH_FLOATING_TYPES</span>(value.<span class="built_in">type</span>(), <span class="string">&quot;ms_deform_attn_forward_cuda&quot;</span>, ([&amp;] &#123;</span><br><span class="line"></span><br><span class="line"># 修改后</span><br><span class="line"><span class="built_in">AT_DISPATCH_FLOATING_TYPES</span>(value.<span class="built_in">scalar_type</span>(), <span class="string">&quot;ms_deform_attn_forward_cuda&quot;</span>, ([&amp;] &#123;</span><br></pre></td></tr></table></figure><h4><span id="q2nameerror-name-_c-is-not-defined">Q2：NameError: name ‘_C’ is not defined</span></h4><p><strong>问题描述</strong>：运行时提示 <code>_C</code> 未定义。</p><p><strong>解决方案</strong>：</p><p>检查CUDA环境变量是否正确设置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$CUDA_HOME</span>    <span class="comment"># 应输出CUDA路径，如 /usr/local/cuda-11.8</span></span><br></pre></td></tr></table></figure><p>更多信息参考：<a href="https://github.com/IDEA-Research/GroundingDINO/blob/main/README.md">GroundingDINO官方文档</a></p><h4><span id="q3安装时提示缺少torch模块">Q3：安装时提示缺少torch模块</span></h4><p><strong>问题描述</strong>：执行 <code>pip install -e .</code> 时报错：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">32</span>, <span class="keyword">in</span> install_torch</span><br><span class="line">ModuleNotFoundError: No module named <span class="string">&#x27;torch&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>解决方案</strong>：</p><p>pip在构建时创建了隔离环境，导致找不到已安装的torch。使用以下命令禁用构建隔离：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -e . --no-build-isolation</span><br></pre></td></tr></table></figure><hr><h3><span id="训练问题">训练问题</span></h3><h4><span id="q1randomsample-typeerror错误">Q1：random.sample TypeError错误</span></h4><p><strong>问题描述</strong>：在 <code>datasets/odvg.py</code> 中运行到以下代码时报错：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vg_labels.extend(random.sample(neg_labels, num_to_add))</span><br></pre></td></tr></table></figure><p>错误信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: Population must be a sequence. For dicts or sets, use sorted(d).</span><br></pre></td></tr></table></figure><p><strong>原因分析</strong>：Python 3.9+版本中，<code>random.sample()</code> 不再接受集合（<code>set</code>）作为输入。</p><p><strong>解决方案</strong>：</p><p>修改 <code>datasets/odvg.py</code> 文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改前</span></span><br><span class="line">vg_labels.extend(random.sample(neg_labels, num_to_add))  <span class="comment"># neg_labels为set类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改后</span></span><br><span class="line">sample_result = random.sample(<span class="built_in">list</span>(neg_labels), num_to_add)</span><br><span class="line">vg_labels.extend(<span class="built_in">set</span>(sample_result))</span><br></pre></td></tr></table></figure><h4><span id="q2coco验证数据集加载keyerror">Q2：COCO验证数据集加载KeyError</span></h4><p><strong>问题描述</strong>：加载COCO格式验证数据集时报错：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res.dataset[<span class="string">&#x27;info&#x27;</span>] = copy.deepcopy(self.dataset[<span class="string">&#x27;info&#x27;</span>])</span><br><span class="line">KeyError: <span class="string">&#x27;info&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>原因分析</strong>：pycocotools版本问题，需要在COCO格式数据集中添加 <code>info</code> 字段。</p><p><strong>解决方案</strong>：</p><p>在COCO格式验证数据集JSON文件开头添加 <code>info</code> 键（参考 <code>./config/instances_val2017.json</code>）：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;info&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;COCO 2017 Dataset&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://cocodataset.org&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;year&quot;</span>: <span class="number">2017</span>,</span><br><span class="line">    <span class="attr">&quot;contributor&quot;</span>: <span class="string">&quot;COCO Consortium&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;date_created&quot;</span>: <span class="string">&quot;2017/09/01&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;images&quot;</span>: [...],</span><br><span class="line">  <span class="attr">&quot;annotations&quot;</span>: [...],</span><br><span class="line">  <span class="attr">&quot;categories&quot;</span>: [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2><span id="参考资料">参考资料</span></h2><ul><li><strong>GroundingDINO官方仓库讨论区</strong>： <a href="https://github.com/IDEA-Research/GroundingDINO/issues">https://github.com/IDEA-Research/GroundingDINO/issues</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Deep-Learning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Fine-tuning </tag>
            
            <tag> GroundingDINO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CLIP自定义数据微调指南</title>
      <link href="/2024/11/08/CLIP%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BE%AE%E8%B0%83%E6%8C%87%E5%8D%97/"/>
      <url>/2024/11/08/CLIP%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BE%AE%E8%B0%83%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2><span id="clip-自定义数据集微调指南">CLIP 自定义数据集微调指南</span></h2><blockquote><p>本文档介绍如何使用自己的数据集微调 CLIP 模型，实现图像-文本对的语义匹配任务。</p></blockquote><h2><span id="目录">目录：</span></h2><p><a href="#%E5%9F%BA%E6%9C%AC%E8%A6%81%E6%B1%82">基本要求</a></p><p><a href="#%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B">完整流程</a></p><ul><li><a href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87">数据准备</a></li><li><a href="#%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">模型训练</a></li><li><a href="#%E6%A8%A1%E5%9E%8B%E6%B5%8B%E8%AF%95">模型测试</a></li></ul><p><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">常见问题</a></p><p><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></p><hr><h2><span id="基本要求">基本要求</span></h2><ul><li><strong>开源仓库：</strong><a href="https://github.com/mlfoundations/open_clip/">open_clip</a></li></ul><h3><span id="环境配置">环境配置</span></h3><ul><li><strong>CUDA</strong>：11.8</li><li><strong>cuDNN</strong>：8.9.3.28</li><li><strong>Python</strong>：3.9.21</li><li><strong>PyTorch</strong>：2.6.0</li></ul><h3><span id="兼容性验证">兼容性验证</span></h3><p>​    <strong>已测试可行环境：</strong>RTX 5090 + CUDA 12.8 + Python 3.12.0 + PyTorch 2.7.0  </p><h3><span id="安装依赖">安装依赖</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆仓库</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/mlfoundations/open_clip/</span><br><span class="line"><span class="built_in">cd</span> open_clip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><hr><h2><span id="完整流程">完整流程</span></h2><h3><span id="数据准备">数据准备</span></h3><h4><span id="step1原始数据">Step1：原始数据</span></h4><p>将分类数据按以下目录结构存放：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Task/                      # 任务根目录</span><br><span class="line">├── cls_1/                 # 类别1（类别名即文件夹名）</span><br><span class="line">│   ├── img_001.jpg</span><br><span class="line">│   ├── img_002.jpg</span><br><span class="line">│   └── ...</span><br><span class="line">└── cls_2/                 # 类别2</span><br><span class="line">    ├── img_001.jpg</span><br><span class="line">    └── ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意：！！！文件夹名称即为类别名，将用于生成文本标签</p></blockquote><h4><span id="step2划分训练集和验证集">Step2：划分训练集和验证集</span></h4><p>使用<code>cls_split_data.py</code>脚本， 脚本将数据按比例划分为 train、val 集：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: python，coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  不均衡数据划分为train、val、test, 图片存储格式 Task/cls_name/image.jpg</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cls_split_data</span>(<span class="params">src_dir, output_root, train_ratio, val_ratio</span>):</span></span><br><span class="line">    <span class="comment"># 支持的图片扩展名</span></span><br><span class="line">    image_exts = &#123;<span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.bmp&quot;</span>, <span class="string">&quot;.tif&quot;</span>, <span class="string">&quot;.tiff&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历所有 disease 层级目录</span></span><br><span class="line">    <span class="keyword">for</span> disease_dir <span class="keyword">in</span> src_dir.rglob(<span class="string">&quot;*&quot;</span>):</span><br><span class="line">        <span class="keyword">if</span> disease_dir.is_dir():</span><br><span class="line">            all_imgs = [p <span class="keyword">for</span> p <span class="keyword">in</span> disease_dir.glob(<span class="string">&quot;*&quot;</span>) <span class="keyword">if</span> p.suffix.lower() <span class="keyword">in</span> image_exts]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> all_imgs:</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># 跳过空文件夹</span></span><br><span class="line"></span><br><span class="line">            random.shuffle(all_imgs)</span><br><span class="line">            n_total = <span class="built_in">len</span>(all_imgs)</span><br><span class="line">            n_train = <span class="built_in">int</span>(np.floor(train_ratio * n_total))</span><br><span class="line">            n_val = <span class="built_in">int</span>(np.ceil(val_ratio * n_total))</span><br><span class="line">            train_imgs = all_imgs[:n_train]</span><br><span class="line">            val_imgs = all_imgs[n_train:n_train + n_val]</span><br><span class="line">            test_imgs = all_imgs[n_train + n_val:]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 相对路径 </span></span><br><span class="line">            rel_path = disease_dir.relative_to(src_dir)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> split_name, split_imgs <span class="keyword">in</span> [(<span class="string">&quot;train&quot;</span>, train_imgs), (<span class="string">&quot;val&quot;</span>, val_imgs)]:</span><br><span class="line">                <span class="keyword">for</span> img <span class="keyword">in</span> split_imgs:</span><br><span class="line">                    target_path = output_root / split_name / rel_path / img.name</span><br><span class="line">                    target_path.parent.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">                    shutil.copy(img, target_path)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;按层级划分完成。&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 原始数据路径</span></span><br><span class="line">    src_dir = Path(<span class="string">&quot;/xxx/open_clip/datasets/Task&quot;</span>)</span><br><span class="line">    <span class="comment"># 保存路径</span></span><br><span class="line">    output_root = Path(<span class="string">&quot;/xxx/open_clip/datasets/Task_split&quot;</span>)</span><br><span class="line">    <span class="comment"># 划分比例</span></span><br><span class="line">    train_ratio, val_ratio = <span class="number">0.8</span>, <span class="number">0.2</span></span><br><span class="line">    <span class="comment"># 分类数据划分</span></span><br><span class="line">    cls_split_data(src_dir, output_root, train_ratio, val_ratio)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>执行脚本</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python cls_split_data.py</span><br></pre></td></tr></table></figure><p><strong>输出结果</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Task_split/                # 输出根目录</span><br><span class="line">├── train/                 # 训练集 (80%)</span><br><span class="line">│   ├── cls_1/</span><br><span class="line">│   │   └── img_001.jpg</span><br><span class="line">│   └── cls_2/</span><br><span class="line">│       └── img_001.jpg</span><br><span class="line">└── val/                   # 验证集 (20%)</span><br><span class="line">    ├── cls_1/</span><br><span class="line">    └── cls_2/</span><br></pre></td></tr></table></figure><h4><span id="step-3-可选-合并已有数据集">Step 3: (可选) 合并已有数据集</span></h4><p>如果需要合并多个数据集：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir target_folder</span><br><span class="line">cp -r folder1/* folder2/* target_folder/</span><br></pre></td></tr></table></figure><h4><span id="step-4-生成-csv-训练文件">Step 4: 生成 CSV 训练文件</span></h4><p>CLIP 模型使用 CSV 格式存储图像-文本对。运行 <code>file2caption.py</code> 脚本生成训练所需的 CSV 文件。</p><p><code>file2caption.py</code>脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: python, coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # 1、生成训练用的csv</span></span><br><span class="line"><span class="string">    # 2、生成所有caption列表保存到json文件下</span></span><br><span class="line"><span class="string">    # 3、得到caption和对应的病害中文名</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_semantics</span>(<span class="params">root_folder, train_csv_file, val_csv_file, cls_text_json, train_rate=<span class="number">0.8</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :purpose: generate clip image-text semantice pair and save csv</span></span><br><span class="line"><span class="string">    :param root_folder: dataset root path</span></span><br><span class="line"><span class="string">    :param train_csv_file: train csv save path</span></span><br><span class="line"><span class="string">    :param val_csv_file: val csv save path</span></span><br><span class="line"><span class="string">    :return: csv</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 获取所有子文件夹中的 JPG 和 PNG 图片文件（包括大写和小写的 .jpg, .JPG, .png, .PNG</span></span><br><span class="line">    image_files = []</span><br><span class="line">    image_extensions = &#123;<span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.bmp&quot;</span>, <span class="string">&quot;.tiff&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> root_folder.rglob(<span class="string">&#x27;*&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> file.is_file() <span class="keyword">and</span> (file.suffix.lower() <span class="keyword">in</span> image_extensions):</span><br><span class="line">            <span class="comment"># 获取文件所在的子文件夹名</span></span><br><span class="line">            subfolder_name = file.parent.name</span><br><span class="line">            image_files.append((file, subfolder_name))</span><br><span class="line">        <span class="comment"># 随机打乱数据</span></span><br><span class="line">        random.shuffle(image_files)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按 subfolder_name 分类</span></span><br><span class="line">    subfolder_dict = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    <span class="keyword">for</span> file, subfolder_name <span class="keyword">in</span> image_files:</span><br><span class="line">        subfolder_dict[subfolder_name].append(file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 训练集和验证集</span></span><br><span class="line">    train_files = []</span><br><span class="line">    val_files = []</span><br><span class="line">    captions_list = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按照输入比例划分每个子文件夹中的数据</span></span><br><span class="line">    <span class="keyword">for</span> subfolder_name, files <span class="keyword">in</span> subfolder_dict.items():</span><br><span class="line">        random.shuffle(files)  <span class="comment"># 随机打乱文件顺序</span></span><br><span class="line">        num_train = <span class="built_in">int</span>(train_rate * <span class="built_in">len</span>(files))</span><br><span class="line">        <span class="comment"># num_val = len(files) - num_train</span></span><br><span class="line"></span><br><span class="line">        train_files.extend(files[:num_train])  <span class="comment"># 添加到训练集</span></span><br><span class="line">        val_files.extend(files[num_train:])  <span class="comment"># 添加到验证集</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加文字并准备数据</span></span><br><span class="line">    train_data = []</span><br><span class="line">    val_data = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 为训练集和验证集生成文件名（包括路径和子文件夹名）</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> train_files:</span><br><span class="line">        new_name = <span class="string">f&quot;<span class="subst">&#123;file.parent&#125;</span>/<span class="subst">&#123;file.name&#125;</span>&quot;</span></span><br><span class="line">        caption = <span class="string">f&quot;A photo of <span class="subst">&#123;file.parent.name&#125;</span>&quot;</span>    <span class="comment"># 此处的caption方式由自己定义</span></span><br><span class="line">        train_data.append([new_name, caption])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> caption <span class="keyword">not</span> <span class="keyword">in</span> captions_list:</span><br><span class="line">            captions_list.append(caption)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> val_files:</span><br><span class="line">        new_name = <span class="string">f&quot;<span class="subst">&#123;file.parent&#125;</span>/<span class="subst">&#123;file.name&#125;</span>&quot;</span></span><br><span class="line">        caption = <span class="string">f&quot;A photo of a <span class="subst">&#123;file.parent.name&#125;</span>&quot;</span></span><br><span class="line">        val_data.append([new_name, caption])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> caption <span class="keyword">not</span> <span class="keyword">in</span> captions_list:</span><br><span class="line">            captions_list.append(caption)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 随机打乱训练集和验证集数据</span></span><br><span class="line">    random.shuffle(train_data)</span><br><span class="line">    random.shuffle(val_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将结果保存到 CSV 文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(train_csv_file, mode=<span class="string">&#x27;w&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        writer = csv.writer(file)</span><br><span class="line">        writer.writerow([<span class="string">&#x27;Image&#x27;</span>, <span class="string">&#x27;Caption&#x27;</span>])  <span class="comment"># CSV 文件头</span></span><br><span class="line">        writer.writerows(train_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(val_csv_file, mode=<span class="string">&#x27;w&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        writer = csv.writer(file)</span><br><span class="line">        writer.writerow([<span class="string">&#x27;Image&#x27;</span>, <span class="string">&#x27;Caption&#x27;</span>])  <span class="comment"># CSV 文件头</span></span><br><span class="line">        writer.writerows(val_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(cls_text_json, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(captions_list, f)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;训练集已保存到 <span class="subst">&#123;train_csv_file&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;验证集已保存到 <span class="subst">&#123;val_csv_file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># ===========================================</span></span><br><span class="line">    <span class="comment"># 未划分数据集，常规数据使用比如crop_identification_250418</span></span><br><span class="line">    root_folder = Path(<span class="string">&#x27;train_data/马山_250515_测试/corn&#x27;</span>)  <span class="comment"># images 根文件夹路径</span></span><br><span class="line">    train_csv_file = <span class="string">&#x27;train_data/马山_250515_测试/mashan.csv&#x27;</span>  <span class="comment"># 结果保存的CSV文件名</span></span><br><span class="line">    val_csv_file = <span class="string">&#x27;train_data/马山_250515_测试/tmp.csv&#x27;</span></span><br><span class="line">    cls_text_json = <span class="string">&#x27;train_data/马山_250515_测试/cls_text.json&#x27;</span></span><br><span class="line">    train_rate = <span class="number">1</span>  <span class="comment"># train的占比</span></span><br><span class="line">    format_semantics(root_folder, train_csv_file, val_csv_file, cls_text_json, train_rate)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>执行命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python utils/file2caption.py</span><br></pre></td></tr></table></figure><p><strong>生成的CSV格式示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Image,Caption</span><br><span class="line">datasets/xxx/DJI_20250707144724_0003_35.jpg,A photo of xxx.</span><br><span class="line">datasets/xxx/org_a9e2f7585c07a6f5_1752478690000.jpg,A photo of xxx.</span><br><span class="line">datasets/xxx/139608.jpg&quot;,Not a photo of xxx.</span><br></pre></td></tr></table></figure><p><strong>CSV 文件说明</strong>：</p><ul><li>第一行：列标识（Image, Caption），无需修改</li><li>后续行：每行包含图片相对路径和对应的文本标签</li><li>Caption 格式可自定义（如 “A photo of {class_name}”）</li></ul><hr><h3><span id="模型训练">模型训练：</span></h3><h4><span id="step-5-执行训练">Step 5: 执行训练</span></h4><p>使用 <code>train.sh</code> 脚本启动训练：</p><p><strong>训练脚本</strong> (<code>train.sh</code>)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置GPU</span></span><br><span class="line"><span class="built_in">export</span> CUDA_VISIBLE_DEVICES=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动训练（后台运行）</span></span><br><span class="line">nohup torchrun --nproc_per_node 1 -m src.open_clip_train.main \</span><br><span class="line">    --batch-size 256 \</span><br><span class="line">    --precision amp \</span><br><span class="line">    --workers 4 \</span><br><span class="line">    --save-frequency 10 \</span><br><span class="line">    --dataset-type csv \</span><br><span class="line">    --csv-separator=<span class="string">&quot;,&quot;</span> \</span><br><span class="line">    --train-data datasets/Task_split/train.csv \</span><br><span class="line">    --val-data datasets/Task_split/val.csv \</span><br><span class="line">    --val-frequency 5 \</span><br><span class="line">    --csv-img-key Image \</span><br><span class="line">    --csv-caption-key Caption \</span><br><span class="line">    --warmup 1000 \</span><br><span class="line">    --lr=5e-6 \</span><br><span class="line">    --wd=0.1 \</span><br><span class="line">    --epochs=100 \</span><br><span class="line">    --model ViT-B-32 \</span><br><span class="line">    --pretrained weights/clip_model/open_clip_pytorch_model.bin \</span><br><span class="line">    --grad-checkpointing \</span><br><span class="line">    --device <span class="string">&quot;cuda&quot;</span> &gt; nohup.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h4><span id="关键参数说明">关键参数说明</span></h4><table><thead><tr><th>参数</th><th>说明</th><th>推荐值</th></tr></thead><tbody><tr><td><code>--train-data</code></td><td>训练集CSV路径</td><td>Step 4生成的train.csv</td></tr><tr><td><code>--val-data</code></td><td>验证集CSV路径</td><td>Step 4生成的val.csv</td></tr><tr><td><code>--csv-img-key</code></td><td>CSV中图片列名</td><td>Image</td></tr><tr><td><code>--csv-caption-key</code></td><td>CSV中文本列名</td><td>Caption</td></tr><tr><td><code>--batch-size</code></td><td>批次大小</td><td>256 (根据显存调整)</td></tr><tr><td><code>--lr</code></td><td>学习率</td><td>5e-6 (微调推荐)</td></tr><tr><td><code>--epochs</code></td><td>训练轮数</td><td>100</td></tr><tr><td><code>--model</code></td><td>模型架构</td><td>ViT-B-32 / ViT-L-14</td></tr><tr><td><code>--pretrained</code></td><td>预训练权重路径</td><td>本地模型路径</td></tr><tr><td><code>--precision</code></td><td>混合精度训练</td><td>amp</td></tr><tr><td><code>--grad-checkpointing</code></td><td>梯度检查点</td><td>启用可节省显存</td></tr></tbody></table><h4><span id="启动训练">启动训练</span></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh train.sh</span><br></pre></td></tr></table></figure><p>训练日志将保存到 <code>nohup.log</code> 文件中。</p><hr><h3><span id="模型测试">模型测试</span></h3><h4><span id="step-6-推理测试">Step 6: 推理测试</span></h4><p>使用训练好的模型进行推理测试：</p><p><strong>测试脚本</strong> (<code>inference.py</code>)：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: python, coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> open_clip</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># === 1. 加载模型 ===</span></span><br><span class="line"><span class="comment"># 方法1: 自动下载预训练模型</span></span><br><span class="line"><span class="comment"># model, _, preprocess = open_clip.create_model_and_transforms(</span></span><br><span class="line"><span class="comment">#     &#x27;ViT-B-32&#x27;,</span></span><br><span class="line"><span class="comment">#     pretrained=&#x27;laion2b_s34b_b79k&#x27;</span></span><br><span class="line"><span class="comment"># )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2: 加载本地微调后的模型</span></span><br><span class="line">model, _, preprocess = open_clip.create_model_and_transforms(</span><br><span class="line">    <span class="string">&#x27;ViT-B-32&#x27;</span>,</span><br><span class="line">    pretrained=<span class="string">&#x27;/path/to/your/finetuned_model.bin&#x27;</span>  <span class="comment"># 替换为你的模型路径</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">model.<span class="built_in">eval</span>()  <span class="comment"># 设置为评估模式</span></span><br><span class="line">tokenizer = open_clip.get_tokenizer(<span class="string">&#x27;ViT-B-32&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># === 2. 准备数据 ===</span></span><br><span class="line"><span class="comment"># 加载测试图像</span></span><br><span class="line">image = preprocess(Image.<span class="built_in">open</span>(<span class="string">&quot;test_img/sample.jpg&quot;</span>)).unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义候选文本标签（根据你的类别自定义）</span></span><br><span class="line">text_labels = [</span><br><span class="line">    <span class="string">&quot;A photo of cls_1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A photo of cls_2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A photo of cls_3&quot;</span></span><br><span class="line">]</span><br><span class="line">text = tokenizer(text_labels)</span><br><span class="line"></span><br><span class="line"><span class="comment"># === 3. 推理 ===</span></span><br><span class="line">start = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> torch.no_grad(), torch.cuda.amp.autocast():</span><br><span class="line">    <span class="comment"># 编码图像和文本</span></span><br><span class="line">    image_features = model.encode_image(image)</span><br><span class="line">    text_features = model.encode_text(text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 归一化特征向量</span></span><br><span class="line">    image_features /= image_features.norm(dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">    text_features /= text_features.norm(dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算相似度并获取概率分布</span></span><br><span class="line">    text_probs = (<span class="number">100.0</span> * image_features @ text_features.T).softmax(dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line"></span><br><span class="line"><span class="comment"># === 4. 输出结果 ===</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;推理时间: <span class="subst">&#123;end - start:<span class="number">.4</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;类别概率: <span class="subst">&#123;text_probs&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\n预测结果:&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> label, prob <span class="keyword">in</span> <span class="built_in">zip</span>(text_labels, text_probs[<span class="number">0</span>]):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  <span class="subst">&#123;label&#125;</span>: <span class="subst">&#123;prob.item():<span class="number">.4</span>f&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h4><span id="运行推理">运行推理</span></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python inference.py</span><br></pre></td></tr></table></figure><p><strong>输出示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">推理时间: 0.0234s</span><br><span class="line">类别概率: tensor([[0.8520, 0.1230, 0.0250]])</span><br><span class="line"></span><br><span class="line">预测结果:</span><br><span class="line">  A photo of cls_1: 0.8520</span><br><span class="line">  A photo of cls_2: 0.1230</span><br><span class="line">  A photo of cls_3: 0.0250</span><br></pre></td></tr></table></figure><hr><h2><span id="常见问题">常见问题</span></h2><h3><span id="1-显存不足-oom">1. 显存不足 (OOM)</span></h3><p><strong>解决方案</strong>：</p><ul><li>减小 <code>--batch-size</code> (如 256 → 128 → 64)</li><li>启用 <code>--grad-checkpointing</code></li><li>使用更小的模型 (ViT-B-32 代替 ViT-L-14)</li></ul><h3><span id="2-训练速度慢">2. 训练速度慢</span></h3><p><strong>优化建议</strong>：</p><ul><li>增加 <code>--workers</code> 数量（数据加载线程）</li><li>使用 <code>--precision amp</code> 混合精度训练</li></ul><h3><span id="3-模型不收敛">3. 模型不收敛</span></h3><p><strong>调试步骤</strong>：</p><ul><li>检查学习率是否过大/过小 (推荐 5e-6 ~ 1e-5)</li><li>增加 <code>--warmup</code> 步数</li><li>确认 CSV 文件格式正确</li><li>检查数据集质量和标签准确性</li></ul><h3><span id="4-caption-设计建议">4. Caption 设计建议</span></h3><p><strong>推荐格式</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单格式</span></span><br><span class="line"><span class="string">&quot;A photo of &#123;class_name&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细格式</span></span><br><span class="line"><span class="string">&quot;This is a photo of &#123;class_name&#125;, which is a type of &#123;category&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 否定样本</span></span><br><span class="line"><span class="string">&quot;Not a photo of &#123;class_name&#125;&quot;</span></span><br></pre></td></tr></table></figure><h3><span id="5-如何选择预训练模型">5. 如何选择预训练模型</span></h3><table><thead><tr><th>模型</th><th>参数量</th><th>性能</th><th>显存需求</th><th>适用场景</th></tr></thead><tbody><tr><td>ViT-B-32</td><td>151M</td><td>中</td><td>~12GB</td><td>快速实验</td></tr><tr><td>ViT-B-16</td><td>149M</td><td>较高</td><td>~16GB</td><td>平衡性能和速度</td></tr><tr><td>ViT-L-14</td><td>427M</td><td>高</td><td>~24GB</td><td>追求最佳性能</td></tr></tbody></table><hr><h2><span id="参考资料">参考资料：</span></h2><ul><li><strong>OpenCLIP 官方仓库讨论区：</strong><a href="https://github.com/mlfoundations/open_clip/discussions/">https://github.com/mlfoundations/open_clip/discussions/</a></li><li><strong>预训练模型下载</strong>: <a href="https://huggingface.co/laion">https://huggingface.co/laion</a></li><li><strong>CLIP 原始论文</strong>: <a href="https://arxiv.org/abs/2103.00020">Learning Transferable Visual Models From Natural Language Supervision</a></li></ul><hr><h2><span id="版本历史">版本历史</span></h2><ul><li><strong>2024-11-08</strong>: 完善文档结构</li></ul>]]></content>
      
      
      <categories>
          
          <category> Deep-Learning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CLIP </tag>
            
            <tag> Fine-tuning </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>X-Anylabeling自动标注学习记录</title>
      <link href="/2024/10/26/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E2%80%94%E2%80%94X-Anylabeling%E8%87%AA%E5%8A%A8%E6%A0%87%E6%B3%A8/"/>
      <url>/2024/10/26/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E2%80%94%E2%80%94X-Anylabeling%E8%87%AA%E5%8A%A8%E6%A0%87%E6%B3%A8/</url>
      
        <content type="html"><![CDATA[<h2><span id="x-anylabeling自动标注学习记录">X-Anylabeling自动标注学习记录</span></h2><blockquote><p>做项目经常接触数据标注和数据预标注，所以就想如果能将标注和预标注的功能集成，做一个可视化界面，那真是提升效率一大福音；当我还在做思想巨人的时候，已经有大佬实现了，着实佩服；好好好，又可以白嫖了。</p></blockquote><h2><span id="目录">目录</span></h2><p><a href="#%E6%AD%A5%E9%AA%A4">步骤</a></p><p><a href="#%E9%9C%80%E6%B1%82%E4%B8%8B%E4%B8%8A%E8%BA%AB">需求下上身</a></p><hr><h2><span id="步骤">步骤</span></h2><p>开源仓库：<a href="https://github.com/CVHub520/X-AnyLabeling">X-AnyLabeling</a></p><h3><span id="1-常规标注">1、常规标注</span></h3><p>这部分就不赘述了，打开文件，然后标注即可，和labelimg类似。</p><h3><span id="2-预训练模型标注">2、预训练模型标注</span></h3><p>详细步骤：</p><ul><li>点击左侧菜单栏第一个文件夹形状的图标，打开想要标注的图片文件夹；<img src="文件夹图标.png" style="zoom:33%;"></li><li>点击左侧菜单栏的倒数第二个图标AI按钮；<img src="AI图标.png" style="zoom:30%;"></li><li>在菜单栏下面会出现选择模型的选择栏，在该选择栏中选择所需功能的预训练模型，选择后会进行自动下载预训练权重，如果显示下载失败可以手动下载，下载地址在工程X-AnyLabeling-main\anylabeling\configs\auto_labeling下的.yaml配置文件中，选择对应模型的配置文件并双击打开，复制model_path后面的网址到浏览器即可下载，下载后将model_path改为存放下载权重的地址；</li><li>点击加载模型框边上的运行按钮，即可实现对当前图片的自动预标注；<img src="运行按钮.png" style="zoom: 33%;"></li><li>若想对打开文件夹里的图片进行批量自动预标注，则在完成上述操作后点击左侧菜单栏最后一个播放图标。<img src="运行图标.png" style="zoom:30%;"></li></ul><h3><span id="3-自训练模型预标注">3、自训练模型预标注</span></h3><p>前提：自己训练的模型必须是XAnylabeling支持的模型，比如yolo11检测目前只支持s模型。（具体可查看配置文件）</p><p>详细步骤：</p><ul><li>将自己训练的模型转为onnx格式；</li><li>在配置文件路径下，复制自训练的模型配置文件，双击打开，修改model_path为自训练转化的onnx存放地址，并修改相关类别。</li><li>后续操作和功能2相同。</li></ul><p><img src="%E7%95%8C%E9%9D%A2.png" alt="加载模型并自动标注界面"></p><center>加载模型并自动标注界面</center><hr><h2><span id="需求侠上身">需求侠上身</span></h2><p>一点衍生，希望之后可以在大佬开源代码的基础上进行实现。</p><h3><span id="1-一键训练功能">1、一键训练功能</span></h3><p>可以将一站式训练平台的思路也添加到上述界面中，这样针对大模型、预训练模型第一次进行自动标注不准的时候，可以标注一部分数据就一键微调模型，通过不断优化模型可得到数据定制化模型和准确的标注信息。</p><h3><span id="2-标注格式转换功能">2、标注格式转换功能</span></h3><p>当前得到的标注信息是以json格式存储，可在上述界面中添加json格式转化为不同标注存储格式的按钮。</p>]]></content>
      
      
      <categories>
          
          <category> AI Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Annotation </tag>
            
            <tag> Labeling </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyQt入门3——构建检测可视化界面</title>
      <link href="/2024/04/04/PyQt%E5%85%A5%E9%97%A83%E2%80%94%E2%80%94%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%A3%80%E6%B5%8B%E5%8F%AF%E8%A7%86%E5%8C%96%E7%95%8C%E9%9D%A2/"/>
      <url>/2024/04/04/PyQt%E5%85%A5%E9%97%A83%E2%80%94%E2%80%94%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%A3%80%E6%B5%8B%E5%8F%AF%E8%A7%86%E5%8C%96%E7%95%8C%E9%9D%A2/</url>
      
        <content type="html"><![CDATA[<h2><span id="构建检测可视化界面">构建检测可视化界面</span></h2><blockquote><p>实现调用海康相机拍照、展示拍摄图片检测结果可视化界面。</p></blockquote><h2><span id="目录">目录</span></h2><p><a href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">实现步骤</a></p><ul><li><a href="#%E7%9B%B8%E6%9C%BA%E8%B0%83%E7%94%A8%EF%BC%88%E6%AD%A4%E5%A4%84%E4%B8%BA%E6%B5%B7%E5%BA%B7%E7%9B%B8%E6%9C%BA%EF%BC%89">相机调用</a></li><li><a href="#%E5%9B%BE%E7%89%87%E5%B1%95%E7%A4%BA">图片展示</a></li><li><a href="#%E5%9B%BE%E7%89%87%E6%95%88%E6%9E%9C%E5%91%88%E7%8E%B0">图片效果呈现</a></li><li><a href="#%E6%96%87%E5%AD%97%E6%95%88%E6%9E%9C%E5%91%88%E7%8E%B0">文字效果呈现</a></li></ul><hr><h2><span id="实现步骤">实现步骤：</span></h2><h3><span id="相机调用此处为海康相机">相机调用（此处为海康相机）</span></h3><p><strong>功能</strong>：python调用相机获取设备、连接设备、获取实时流、点击拍照。</p><p><strong>参考教程</strong>：<a href="https://blog.csdn.net/weixin_42795788/article/details/124407780?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171265172616800180696524%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=171265172616800180696524&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-124407780-null-null.nonecase&utm_term=qt&spm=1018.2226.3001.4450">PyQt5打开海康工业相机</a></p><h3><span id="图片展示">图片展示</span></h3><p>功能：滚动框展示拍摄图片，时间从近到远排序，按钮点击图片放大展示在新QLabel中。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QWidget, QListWidget, QLabel, QListWidgetItem</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> QPixmap</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> pyqtSignal</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义QListWidget类，实现上述功能</span></span><br><span class="line"><span class="comment"># 滚动框缩略图展示，点击放大功能</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageListWidget</span>(<span class="params">QListWidget</span>):</span></span><br><span class="line">    imageClicked = pyqtSignal(QPixmap)  <span class="comment"># 自定义信号，用于点击 QLabel 时发射信号</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(parent)</span><br><span class="line">        <span class="comment"># self.setFlow(QListWidget.LeftToRight)  # 从左到右</span></span><br><span class="line">        self.setResizeMode(QListWidget.Adjust)  <span class="comment"># 自动调整大小</span></span><br><span class="line">        self.setViewMode(QListWidget.IconMode)  <span class="comment"># 以图标形式展示</span></span><br><span class="line">        <span class="comment"># self.setIconSize(QSize(200, 200))   # 设置图标大小</span></span><br><span class="line">        <span class="comment"># self.setSelectionMode(QListWidget.SingleSelection)  # 设置单选模式</span></span><br><span class="line">        self.pixmaps = []  <span class="comment"># 存储每个图片的pixmap</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_image</span>(<span class="params">self, pixmap, img_show_input</span>):</span></span><br><span class="line">        <span class="comment"># 方式1，以item图标展示</span></span><br><span class="line">        <span class="comment"># item = QListWidgetItem()</span></span><br><span class="line">        <span class="comment"># # item.setIcon(QIcon(pixmap))    # 以item图标展示</span></span><br><span class="line">        <span class="comment"># self.addItem(item)</span></span><br><span class="line"></span><br><span class="line">        self.pixmaps.append(pixmap)  <span class="comment"># 存储当前图片的pixmap</span></span><br><span class="line">        <span class="comment"># 方式二，以qlabel作为小部件添加到item中展示</span></span><br><span class="line">        item = QListWidgetItem()</span><br><span class="line">        label = QLabel()  <span class="comment"># 创建 QLabel</span></span><br><span class="line">        label.setPixmap(pixmap.scaled(img_show_input.size().width(), img_show_input.size().height()))</span><br><span class="line">        item.setSizeHint(img_show_input.size())</span><br><span class="line">        self.addItem(item)</span><br><span class="line">        self.setItemWidget(item, label)  <span class="comment"># 将 QLabel 设置为列表项的小部件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># label.mousePressEvent = lambda event, pixmap=pixmap: self.imageClicked.emit(pixmap)  # 为 QLabel 添加点击事件处理函数</span></span><br><span class="line">        index = <span class="built_in">len</span>(self.pixmaps) - <span class="number">1</span></span><br><span class="line">        label.mousePressEvent = <span class="keyword">lambda</span> event, index=index: self.imageClicked.emit(</span><br><span class="line">            self.pixmaps[index])  <span class="comment"># 为 QLabel 添加点击事件处理函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主窗口</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建一个滚动图片展示区域</span></span><br><span class="line">        self.image_list_widget = ImageListWidget(self)</span><br><span class="line">        <span class="comment"># 方式1，设置位置和大小</span></span><br><span class="line">        self.image_list_widget.move(<span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">        self.image_list_widget.setFixedSize(<span class="number">600</span>, <span class="number">600</span>)</span><br><span class="line">        self.image_list_widget.setStyleSheet(<span class="string">&quot;background-color: white;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建用于显示放大图片的 QLabel</span></span><br><span class="line">        self.enlarged_image_label = QLabel(self)</span><br><span class="line">        self.enlarged_image_label.setGeometry(<span class="number">650</span>, <span class="number">100</span>, <span class="number">600</span>, <span class="number">600</span>)  <span class="comment"># 方式2，设置位置和大小</span></span><br><span class="line">        self.enlarged_image_label.setStyleSheet(<span class="string">&quot;background-color: white;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加多张图片到滚动区域中</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            pixmap = QPixmap(<span class="string">f&quot;tmp/<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>.jpg&quot;</span>)  <span class="comment"># 从文件加载图片</span></span><br><span class="line">            self.image_list_widget.add_image(pixmap, self.enlarged_image_label)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 连接点击信号到显示放大图片的函数</span></span><br><span class="line">        self.image_list_widget.imageClicked.connect(self.show_enlarged_image)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_enlarged_image</span>(<span class="params">self, pixmap</span>):</span></span><br><span class="line">        self.enlarged_image_label.setPixmap(pixmap)  <span class="comment"># 在另一个 QLabel 中显示放大的图片</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication([])</span><br><span class="line">    window = MainWindow()</span><br><span class="line">    window.resize(<span class="number">1200</span>, <span class="number">1200</span>)  <span class="comment"># 设置窗口大小</span></span><br><span class="line">    window.show()</span><br><span class="line">    app.exec_()</span><br></pre></td></tr></table></figure><h3><span id="图片效果呈现">图片效果呈现</span></h3><p>功能：展示检测后画框图片，具有鼠标处放大、鼠标拖动等功能。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  自定义CustomLabel类实现指定鼠标位置滚轮缩放，鼠标拖动</span></span><br><span class="line"><span class="string">  QLabel功能调试</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> QImage, QPixmap, QIcon, QColor, QWheelEvent, QMouseEvent</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> pyqtSlot, QSize, Qt, pyqtSignal, QEvent</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QTextBrowser, QWidget, QLabel, QPushButton, QFileDialog, QFrame, QMessageBox, \</span><br><span class="line">    QListWidgetItem, QSizePolicy, QListWidget, QScrollArea</span><br><span class="line"><span class="keyword">from</span> PyQt5.Qt <span class="keyword">import</span> QPainter, QPoint</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomLabel</span>(<span class="params">QLabel</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(parent)</span><br><span class="line">        self.setMouseTracking(<span class="literal">True</span>)</span><br><span class="line">        self.img = <span class="literal">None</span></span><br><span class="line">        self.scaled_img = <span class="literal">None</span></span><br><span class="line">        self.start_pos = <span class="literal">None</span></span><br><span class="line">        self.end_pos = <span class="literal">None</span></span><br><span class="line">        self.left_click = <span class="literal">False</span></span><br><span class="line">        self.wheel_flag = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        self.scale = <span class="number">1</span></span><br><span class="line">        self.old_scale = <span class="number">1</span></span><br><span class="line">        self.point = QPoint(<span class="number">0</span>, <span class="number">0</span>)  <span class="comment"># 图片左上角位置</span></span><br><span class="line">        self.rb_point = QPoint(<span class="number">0</span>, <span class="number">0</span>)  <span class="comment"># 图片左上角位置</span></span><br><span class="line">        self.old_rb_point = QPoint(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        self.x = -<span class="number">1</span></span><br><span class="line">        self.y = -<span class="number">1</span></span><br><span class="line">        self.new_height = -<span class="number">1</span></span><br><span class="line">        self.new_width = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_image</span>(<span class="params">self, img</span>):</span></span><br><span class="line">        <span class="comment"># self.img = QPixmap(img_path)</span></span><br><span class="line">        self.img = img</span><br><span class="line">        width, height = self.img.width(), self.img.height()</span><br><span class="line">        self.img = self.img.scaled(width, height, Qt.KeepAspectRatio)</span><br><span class="line">        self.scaled_img = self.img</span><br><span class="line"></span><br><span class="line">        self.new_height = height</span><br><span class="line">        self.new_width = width</span><br><span class="line">        self.scale = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paintEvent</span>(<span class="params">self, e</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.scaled_img:</span><br><span class="line">            painter = QPainter()</span><br><span class="line">            painter.begin(self)</span><br><span class="line">            painter.scale(self.scale, self.scale)</span><br><span class="line">            <span class="keyword">if</span> self.wheel_flag:  <span class="comment"># 定点缩放</span></span><br><span class="line">                self.wheel_flag = <span class="literal">False</span></span><br><span class="line">                <span class="comment"># 判断当前鼠标pos在不在图上</span></span><br><span class="line">                this_left_x = self.point.x() * self.old_scale  <span class="comment"># 当前图片左上角在窗口的位置</span></span><br><span class="line">                this_left_y = self.point.y() * self.old_scale</span><br><span class="line"></span><br><span class="line">                this_scale_width = self.new_width * self.old_scale</span><br><span class="line">                this_scale_height = self.new_height * self.old_scale</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 鼠标点在图上，以鼠标点为中心动作</span></span><br><span class="line">                gap_x = self.x - this_left_x  <span class="comment"># 鼠标位置相对左上角的偏移量</span></span><br><span class="line">                gap_y = self.y - this_left_y</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="number">0</span> &lt; gap_x &lt; this_scale_width <span class="keyword">and</span> <span class="number">0</span> &lt; gap_y &lt; this_scale_height:</span><br><span class="line">                    new_left_x = <span class="built_in">int</span>(self.x / self.scale - gap_x / self.old_scale)  <span class="comment"># 根据鼠标位置重新计算图像左上角位置</span></span><br><span class="line">                    new_left_y = <span class="built_in">int</span>(self.y / self.scale - gap_y / self.old_scale)</span><br><span class="line"></span><br><span class="line">                    self.point = QPoint(new_left_x, new_left_y)</span><br><span class="line">                    self.rb_point = QPoint(new_left_x + this_scale_width,</span><br><span class="line">                                           new_left_y + this_scale_height)</span><br><span class="line"></span><br><span class="line">            painter.drawPixmap(self.point, self.scaled_img)  <span class="comment"># 此函数中还会用scale对point进行处理</span></span><br><span class="line">            painter.end()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wheelEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        angle = event.angleDelta() / <span class="number">8</span>  <span class="comment"># 返回QPoint对象，为滚轮转过的数值，单位为1/8度</span></span><br><span class="line">        angleY = angle.y()</span><br><span class="line">        self.old_scale = self.scale</span><br><span class="line">        self.x, self.y = event.x(), event.y()  <span class="comment"># 鼠标位置</span></span><br><span class="line">        self.wheel_flag = <span class="literal">True</span></span><br><span class="line">        <span class="comment"># 获取当前鼠标相对于view的位置</span></span><br><span class="line">        <span class="keyword">if</span> angleY &gt; <span class="number">0</span>:</span><br><span class="line">            self.scale *= <span class="number">1.05</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 滚轮下滚</span></span><br><span class="line">            self.scale *= <span class="number">0.95</span></span><br><span class="line">        <span class="keyword">if</span> self.scale &lt; <span class="number">1</span>:  <span class="comment"># 最小尺寸为原图大小，比例为1</span></span><br><span class="line">            self.scale = <span class="number">1</span></span><br><span class="line">        self.adjustSize()</span><br><span class="line">        self.update()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 鼠标拖动</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseMoveEvent</span>(<span class="params">self, e</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.left_click:</span><br><span class="line">            self.end_pos = e.pos() - self.start_pos  <span class="comment"># 当前位置-起始位置=差值，e.pos()当前鼠标位置，返回(x,y)</span></span><br><span class="line">            lt_new_point = self.point + self.end_pos / self.scale  <span class="comment"># 图片左上角的距离变化</span></span><br><span class="line"></span><br><span class="line">            rb_new_point2 = self.rb_point + self.end_pos / self.scale</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 限制拖动图片到QLabel控件中（限制了图片左上角）</span></span><br><span class="line">            <span class="keyword">if</span> lt_new_point.x() &gt; <span class="number">0</span>:</span><br><span class="line">                lt_new_point.setX(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> lt_new_point.y() &gt; <span class="number">0</span>:</span><br><span class="line">                lt_new_point.setY(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># TODO 限制右下角拖进QLabel控件中（暂未实现，待优化）</span></span><br><span class="line">            <span class="comment"># 检查右下角是否超出 QLabel 控件的边界</span></span><br><span class="line">            <span class="comment">#if rb_new_point2.x() &lt; self.width() - 1:</span></span><br><span class="line">            <span class="comment">#    print(&quot;右下角的最大移动量：&quot;, (self.old_rb_point.x() - self.width()) / self.scale)</span></span><br><span class="line">            <span class="comment">#    lt_new_point.setX(int(self.point.x() - (self.old_rb_point.x() - self.width()) / self.scale))</span></span><br><span class="line">            <span class="comment">#    rb_new_point2.setX(self.width())</span></span><br><span class="line">            <span class="comment">#self.old_rb_point = rb_new_point2</span></span><br><span class="line">            <span class="comment">#self.rb_point = rb_new_point2</span></span><br><span class="line">            <span class="comment">#self.point = lt_new_point  # 更新图片左上角位置</span></span><br><span class="line">            <span class="comment">#self.start_pos = e.pos()</span></span><br><span class="line">            <span class="comment">#self.repaint()  # 重新画图</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mousePressEvent</span>(<span class="params">self, e</span>):</span></span><br><span class="line">        <span class="keyword">if</span> e.button() == Qt.LeftButton:</span><br><span class="line">            self.left_click = <span class="literal">True</span>  <span class="comment"># 开始拖动</span></span><br><span class="line">            self.start_pos = e.pos()  <span class="comment"># 记录鼠标点击位置</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouseReleaseEvent</span>(<span class="params">self, e</span>):</span></span><br><span class="line">        <span class="keyword">if</span> e.button() == Qt.LeftButton:</span><br><span class="line">            self.left_click = <span class="literal">False</span>  <span class="comment"># 停止拖动</span></span><br></pre></td></tr></table></figure><h3><span id="文字效果呈现">文字效果呈现</span></h3><p>功能：在滚动框控件中以QLabel嵌套展示。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QWidget, QLabel, QScrollArea</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个滚动区域</span></span><br><span class="line">    scroll_area = QScrollArea()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个 QWidget 作为滚动区域的内容</span></span><br><span class="line">    container = QWidget(scroll_area)</span><br><span class="line"></span><br><span class="line">    not_other_num = <span class="number">0</span>  <span class="comment"># 父 QLabel 的数量计数器</span></span><br><span class="line">    y_offset = <span class="number">0</span>  <span class="comment"># 控制纵向位置的偏移量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):  <span class="comment"># 示例循环 5 次</span></span><br><span class="line">        <span class="comment"># 创建父级 QLabel</span></span><br><span class="line">        parent_label = QLabel(container)</span><br><span class="line">        parent_label.setGeometry(<span class="number">0</span>, y_offset, <span class="number">200</span>, <span class="number">50</span>)  <span class="comment"># 设置父级 QLabel 的位置和大小</span></span><br><span class="line">        parent_label.setStyleSheet(<span class="string">&quot;background-color: yellow;&quot;</span>)  <span class="comment"># 设置父级 QLabel 的背景颜色</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建两个包含文字的 QLabel</span></span><br><span class="line">        label1 = QLabel(<span class="string">&quot;Label 1&quot;</span>, parent=parent_label)</span><br><span class="line">        label1.setGeometry(<span class="number">10</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">30</span>)  <span class="comment"># 设置第一个 QLabel 的位置和大小</span></span><br><span class="line">        label1.setStyleSheet(<span class="string">&quot;background-color: red&quot;</span>)  <span class="comment"># 设置第一个 QLabel 的背景颜色</span></span><br><span class="line"></span><br><span class="line">        label2 = QLabel(<span class="string">&quot;Label 2&quot;</span>, parent=parent_label)</span><br><span class="line">        label2.setGeometry(<span class="number">100</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">30</span>)  <span class="comment"># 设置第二个 QLabel 的位置和大小</span></span><br><span class="line">        label2.setStyleSheet(<span class="string">&quot;background-color: blue&quot;</span>)  <span class="comment"># 设置第二个 QLabel 的背景颜色</span></span><br><span class="line"></span><br><span class="line">        not_other_num += <span class="number">1</span></span><br><span class="line">        y_offset += <span class="number">60</span>  <span class="comment"># 更新纵向位置偏移量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置容器的固定大小</span></span><br><span class="line">    container.setFixedSize(<span class="number">200</span>, y_offset)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将容器设置为滚动区域的 widget</span></span><br><span class="line">    scroll_area.setWidget(container)</span><br><span class="line"></span><br><span class="line">    scroll_area.show()</span><br><span class="line"></span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure><h3><span id="细节优化">细节优化：</span></h3><p>​    1、所有控件随窗口自适应缩放：使用resizeEvent()函数</p><p>​    2、相机是否连接监控：使用QTimer()创建一个定时器，每隔一段时间检查相机状态。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Window</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        QWidget.__init__(self)</span><br><span class="line">        <span class="comment">#   界面显示相关内容</span></span><br><span class="line">        self.initUI()</span><br><span class="line">        <span class="comment"># ------创建一个定时器，每隔一定时间检查一次相机状态-----</span></span><br><span class="line">        self.timer = QTimer()</span><br><span class="line">        self.timer.timeout.connect(self.MonitorLight)</span><br><span class="line">        self.timer.start(<span class="number">1000</span>)  <span class="comment"># 每隔1秒检查一次相机状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----监控相机是否连接-----</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">MonitorLight</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;连接中&quot;</span>)   <span class="comment"># 替换为自己的实现功能</span></span><br></pre></td></tr></table></figure><h2><span id="版本历史">版本历史</span></h2><ul><li><strong>2024-04-04</strong>：输出初版文档</li><li><strong>2025-02-07</strong>：完善文档结构</li></ul>]]></content>
      
      
      <categories>
          
          <category> Engineering </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PyQt </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyQt入门2——构建一个标注数据处理功能界面</title>
      <link href="/2024/02/25/PyQt%E5%85%A5%E9%97%A82%E2%80%94%E2%80%94%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%A0%87%E6%B3%A8%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%8A%9F%E8%83%BD%E7%95%8C%E9%9D%A2/"/>
      <url>/2024/02/25/PyQt%E5%85%A5%E9%97%A82%E2%80%94%E2%80%94%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%A0%87%E6%B3%A8%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%8A%9F%E8%83%BD%E7%95%8C%E9%9D%A2/</url>
      
        <content type="html"><![CDATA[<h2><span id="构建一个标注数据处理功能界面">构建一个标注数据处理功能界面</span></h2><blockquote><p>将处理标注数据的功能脚本集成到一个简单的可视化界面。</p></blockquote><h2><span id="目录">目录</span></h2><p><a href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">实现步骤</a></p><p><a href="#%E5%85%A8%E9%83%A8%E4%BB%A3%E7%A0%81">全部代码</a></p><p><a href="#%E7%95%8C%E9%9D%A2%E5%B1%95%E7%A4%BA">界面展示</a></p><hr><h2><span id="实现步骤">实现步骤</span></h2><h3><span id="step1主窗口">Step1：主窗口</span></h3><p>包含一个功能选择按钮。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ----------创建主窗口----------</span></span><br><span class="line">self.setWindowTitle(<span class="string">&#x27;数据处理平台&#x27;</span>)</span><br><span class="line">self.resize(<span class="number">640</span>, <span class="number">480</span>) <span class="comment"># 窗口大小</span></span><br><span class="line"><span class="comment"># self.setGeometry(100, 100, 640, 480)</span></span><br><span class="line"></span><br><span class="line">self.button_txt = QPushButton(<span class="string">&#x27;功能选择&#x27;</span>, self)</span><br><span class="line">self.button_txt.setGeometry(<span class="number">20</span>, <span class="number">20</span>, <span class="number">130</span>, <span class="number">30</span>)</span><br></pre></td></tr></table></figure><h3><span id="step2功能选择多功能">Step2：功能选择（多功能）</span></h3><p>以下拉框的形式进行选择，通过点击选项触发对应功能窗口。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ----------创建下拉菜单----------</span></span><br><span class="line"><span class="comment"># 创建下拉菜单</span></span><br><span class="line">self.combobox_txt = QComboBox(self)</span><br><span class="line">self.combobox_txt.addItems([<span class="string">&#x27;未选择&#x27;</span>, <span class="string">&#x27;xml2txt&#x27;</span>, <span class="string">&#x27;change xml label&#x27;</span>])</span><br><span class="line"><span class="comment"># self.combobox_txt.hide()  # 初始隐藏下拉菜单</span></span><br><span class="line"><span class="comment"># self.combobox_txt.setCurrentIndex(-1)  # 设置初始索引为 -1, 必须在添加控件之前设置</span></span><br><span class="line">self.combobox_txt.setGeometry(self.button_txt.x(), self.button_txt.y() + self.button_txt.height(), <span class="number">130</span>, <span class="number">30</span>)</span><br><span class="line">self.combobox_txt.activated.connect(</span><br><span class="line">            <span class="keyword">lambda</span>: self.switch_page(self.combobox_txt, self.stacked_widget))  <span class="comment"># 绑定选择事件, activated会自动传输index，从0开始。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------创建下拉菜单对应的切换界面----------</span></span><br><span class="line">self.stacked_widget = QStackedWidget(self)  <span class="comment"># 创建叠加窗口</span></span><br><span class="line">self.stacked_widget.setGeometry(<span class="number">50</span>, <span class="number">100</span>, <span class="number">600</span>, <span class="number">600</span>)  <span class="comment"># 设置窗口位置</span></span><br></pre></td></tr></table></figure><h3><span id="step3触发切换界面">Step3：触发切换界面</span></h3><p>activated槽函数switch_page，触发界面切换。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----下拉选项触发-----</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">switch_page</span>(<span class="params">self, combobox, stacked_widget</span>):</span></span><br><span class="line">    index = combobox.currentIndex()</span><br><span class="line">    stacked_widget.setCurrentIndex(index)</span><br></pre></td></tr></table></figure><h3><span id="step4不同功能界面">Step4：不同功能界面</span></h3><p>在对应界面添加文本框（QLabel类）、输入框控件（QLineEdit类）、按钮控件（QPushButton类），setPlaceholderText类表示在输入框中添加文字提示，提示输入参数格式示例。按钮控件点击触发功能函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ----------切换界面示例----------</span></span><br><span class="line"><span class="comment"># page1  xml to txt</span></span><br><span class="line">self.page1_xml = QWidget()</span><br><span class="line"></span><br><span class="line">self.page1_label1_xml = QLabel(<span class="string">&#x27;img_root:&#x27;</span>, self.page1_xml)  <span class="comment"># 在page1里面添加输入框控件</span></span><br><span class="line">self.page1_label1_xml.setGeometry(<span class="number">25</span>, <span class="number">20</span>, <span class="number">100</span>, <span class="number">30</span>)</span><br><span class="line">self.page1_input_field1_xml = QLineEdit(self.page1_xml)</span><br><span class="line">self.page1_input_field1_xml.setPlaceholderText(<span class="string">&quot;输入图片地址：./ImgFilePath&quot;</span>)</span><br><span class="line">self.page1_input_field1_xml.setGeometry(<span class="number">110</span>, <span class="number">25</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">self.page1_label2_xml = QLabel(<span class="string">&#x27;xml_root:&#x27;</span>, self.page1_xml)</span><br><span class="line">self.page1_label2_xml.setGeometry(<span class="number">25</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">30</span>)  <span class="comment"># (x,y, h, w)</span></span><br><span class="line">self.page1_input_field2_xml = QLineEdit(self.page1_xml)</span><br><span class="line">self.page1_input_field2_xml.setPlaceholderText(<span class="string">&quot;输入xml地址：./XmlFilePath&quot;</span>)</span><br><span class="line">self.page1_input_field2_xml.setGeometry(<span class="number">110</span>, <span class="number">55</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">self.page1_label3_xml = QLabel(<span class="string">&#x27;classes:&#x27;</span>, self.page1_xml)</span><br><span class="line">self.page1_label3_xml.setGeometry(<span class="number">25</span>, <span class="number">80</span>, <span class="number">100</span>, <span class="number">30</span>)</span><br><span class="line">self.page1_input_field3_xml = QLineEdit(self.page1_xml)</span><br><span class="line">self.page1_input_field3_xml.setPlaceholderText(<span class="string">&quot;输入类别列表格式：[fg, a1], 字符也不用引号&quot;</span>)</span><br><span class="line">self.page1_input_field3_xml.setGeometry(<span class="number">110</span>, <span class="number">85</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">self.page1_label4_xml = QLabel(<span class="string">&#x27;save_txt_root:&#x27;</span>, self.page1_xml)</span><br><span class="line">self.page1_label4_xml.setGeometry(<span class="number">10</span>, <span class="number">110</span>, <span class="number">120</span>, <span class="number">30</span>)  <span class="comment"># (x,y, h, w)</span></span><br><span class="line">self.page1_input_field4_xml = QLineEdit(self.page1_xml)</span><br><span class="line">self.page1_input_field4_xml.setPlaceholderText(<span class="string">&quot;输入txt保存地址：./TxtFilePath&quot;</span>)</span><br><span class="line">self.page1_input_field4_xml.setGeometry(<span class="number">130</span>, <span class="number">115</span>, <span class="number">280</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">self.stacked_widget.addWidget(self.page1_xml)</span><br></pre></td></tr></table></figure><h3><span id="step5参数接收">Step5：参数接收</span></h3><p>对输入框中的信息进行接收，获取数据为str类型。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xml2txt_button_click</span>(<span class="params">self</span>):</span></span><br><span class="line">    img_root = self.page1_input_field1_xml.text()  <span class="comment"># 标注图片路径</span></span><br><span class="line">    xml_root = self.page1_input_field2_xml.text()  <span class="comment"># xml地址</span></span><br><span class="line">    input_classes = self.page1_input_field3_xml.text()  <span class="comment"># classes列表</span></span><br><span class="line">    classes = input_classes[<span class="number">1</span>:-<span class="number">1</span>].split(<span class="string">&#x27;, &#x27;</span>)  <span class="comment"># 获取为str类型数据，转为list</span></span><br><span class="line">    txt_root = self.page1_input_field4_xml.text()  <span class="comment"># txt保存地址</span></span><br></pre></td></tr></table></figure><h3><span id="step6按钮触发函数">Step6：按钮触发函数</span></h3><p>点击按钮触发槽函数，xml2txt_button_click替换为自己的功能函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该部分可添加到步骤3中</span></span><br><span class="line">self.page1_submit_button_xml = QPushButton(<span class="string">&quot;运行&quot;</span>, self.page1_xml)</span><br><span class="line">self.page1_submit_button_xml.setGeometry(<span class="number">250</span>, <span class="number">200</span>, <span class="number">70</span>, <span class="number">30</span>)</span><br><span class="line">self.page1_submit_button_xml.clicked.connect(self.xml2txt_button_click)  <span class="comment"># 运行按钮调用函数</span></span><br></pre></td></tr></table></figure><h3><span id="step7函数运行反馈">Step7：函数运行反馈</span></h3><p>运行成功提示success，运行失败提示错误详情。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----异常处理，运行反馈-----</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 功能函数xml2txt替换为自己的函数</span></span><br><span class="line">    xml2txt(xml_root, xml_name, txt_save_path, classes, img_root)</span><br><span class="line">    <span class="comment"># 成功运行提示</span></span><br><span class="line">    QMessageBox.information(self, <span class="string">&#x27;Success&#x27;</span>, <span class="string">&#x27;Your program has run successfully!&#x27;</span>, QMessageBox.Ok)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="comment"># 捕获异常并显示错误消息</span></span><br><span class="line">    QMessageBox.critical(self, <span class="string">&#x27;Error&#x27;</span>, <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h3><span id="step8主程序">Step8：主程序</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    window = MyWindow()</span><br><span class="line">    window.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure><h2><span id="全部代码">全部代码：</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QWidget, QPushButton, QLabel, QLineEdit, QStackedWidget, \</span><br><span class="line">    QComboBox, QMessageBox</span><br><span class="line"><span class="keyword">from</span> utils.label_utils <span class="keyword">import</span> xml2txt, change_xml_label</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主界面</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWindow</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ----------创建界面----------</span></span><br><span class="line">        self.setWindowTitle(<span class="string">&#x27;数据处理平台&#x27;</span>)</span><br><span class="line">        self.resize(<span class="number">640</span>, <span class="number">480</span>)</span><br><span class="line">        <span class="comment"># self.setGeometry(100, 100, 640, 480)</span></span><br><span class="line"></span><br><span class="line">        self.button_txt = QPushButton(<span class="string">&#x27;功能选择&#x27;</span>, self)</span><br><span class="line">        self.button_txt.setGeometry(<span class="number">20</span>, <span class="number">20</span>, <span class="number">130</span>, <span class="number">30</span>)</span><br><span class="line">        self.button_txt.clicked.connect(self.show_combobox)  <span class="comment"># 传入自定义参数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ----------创建下拉菜单----------</span></span><br><span class="line">        <span class="comment"># 创建txt下拉菜单</span></span><br><span class="line">        self.combobox_txt = QComboBox(self)</span><br><span class="line">        self.combobox_txt.addItems([<span class="string">&#x27;未选择&#x27;</span>, <span class="string">&#x27;xml2txt&#x27;</span>, <span class="string">&#x27;change xml label&#x27;</span>])</span><br><span class="line">        <span class="comment"># self.combobox_txt.hide()  # 初始隐藏下拉菜单</span></span><br><span class="line">        <span class="comment"># self.combobox_txt.setCurrentIndex(-1)  # 设置初始索引为 -1, 必须在添加控件之前设置</span></span><br><span class="line">        self.combobox_txt.setGeometry(self.button_txt.x(), self.button_txt.y() + self.button_txt.height(), <span class="number">130</span>, <span class="number">30</span>)</span><br><span class="line">        <span class="comment"># self.combobox_txt.move(self.button_txt.x(), self.button_txt.y() + self.button_txt.height())  # 移动控件到下（x,y）位置</span></span><br><span class="line">        self.combobox_txt.activated.connect(</span><br><span class="line">            <span class="keyword">lambda</span>: self.switch_page(self.combobox_txt, self.stacked_widget))  <span class="comment"># 绑定选择事件, activated会自动传输index</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ----------创建下拉菜单对应的切换界面----------</span></span><br><span class="line">        <span class="comment"># -----界面切换模块-----</span></span><br><span class="line">        self.stacked_widget = QStackedWidget(self)  <span class="comment"># 创建叠加窗口</span></span><br><span class="line">        self.stacked_widget.setGeometry(<span class="number">50</span>, <span class="number">100</span>, <span class="number">600</span>, <span class="number">600</span>)  <span class="comment"># 设置窗口位置</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># page0 默认空界面</span></span><br><span class="line">        self.page0_xml = QWidget()</span><br><span class="line">        self.stacked_widget.addWidget(self.page0_xml)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># -----创建处理界面-----</span></span><br><span class="line">        <span class="comment"># page1  xml to txt</span></span><br><span class="line">        self.page1_xml = QWidget()</span><br><span class="line"></span><br><span class="line">        self.page1_label1_xml = QLabel(<span class="string">&#x27;img_root:&#x27;</span>, self.page1_xml)  <span class="comment"># 在page1里面添加输入框控件</span></span><br><span class="line">        self.page1_label1_xml.setGeometry(<span class="number">25</span>, <span class="number">20</span>, <span class="number">100</span>, <span class="number">30</span>)</span><br><span class="line">        self.page1_input_field1_xml = QLineEdit(self.page1_xml)</span><br><span class="line">        self.page1_input_field1_xml.setPlaceholderText(<span class="string">&quot;输入图片地址：./ImgFilePath&quot;</span>)</span><br><span class="line">        self.page1_input_field1_xml.setGeometry(<span class="number">110</span>, <span class="number">25</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.page1_label2_xml = QLabel(<span class="string">&#x27;xml_root:&#x27;</span>, self.page1_xml)</span><br><span class="line">        self.page1_label2_xml.setGeometry(<span class="number">25</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">30</span>)  <span class="comment"># (x,y, h, w)</span></span><br><span class="line">        self.page1_input_field2_xml = QLineEdit(self.page1_xml)</span><br><span class="line">        self.page1_input_field2_xml.setPlaceholderText(<span class="string">&quot;输入xml地址：./XmlFilePath&quot;</span>)</span><br><span class="line">        self.page1_input_field2_xml.setGeometry(<span class="number">110</span>, <span class="number">55</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.page1_label3_xml = QLabel(<span class="string">&#x27;classes:&#x27;</span>, self.page1_xml)</span><br><span class="line">        self.page1_label3_xml.setGeometry(<span class="number">25</span>, <span class="number">80</span>, <span class="number">100</span>, <span class="number">30</span>)</span><br><span class="line">        self.page1_input_field3_xml = QLineEdit(self.page1_xml)</span><br><span class="line">        self.page1_input_field3_xml.setPlaceholderText(<span class="string">&quot;输入类别列表格式：[fg, a1], 字符也不用引号&quot;</span>)</span><br><span class="line">        self.page1_input_field3_xml.setGeometry(<span class="number">110</span>, <span class="number">85</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.page1_label4_xml = QLabel(<span class="string">&#x27;save_txt_root:&#x27;</span>, self.page1_xml)</span><br><span class="line">        self.page1_label4_xml.setGeometry(<span class="number">10</span>, <span class="number">110</span>, <span class="number">120</span>, <span class="number">30</span>)  <span class="comment"># (x,y, h, w)</span></span><br><span class="line">        self.page1_input_field4_xml = QLineEdit(self.page1_xml)</span><br><span class="line">        self.page1_input_field4_xml.setPlaceholderText(<span class="string">&quot;输入txt保存地址：./TxtFilePath&quot;</span>)</span><br><span class="line">        self.page1_input_field4_xml.setGeometry(<span class="number">130</span>, <span class="number">115</span>, <span class="number">280</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.page1_submit_button_xml = QPushButton(<span class="string">&quot;运行&quot;</span>, self.page1_xml)</span><br><span class="line">        self.page1_submit_button_xml.setGeometry(<span class="number">250</span>, <span class="number">200</span>, <span class="number">70</span>, <span class="number">30</span>)</span><br><span class="line">        self.page1_submit_button_xml.clicked.connect(self.xml2txt_button_click)  <span class="comment"># 运行按钮调用函数</span></span><br><span class="line"></span><br><span class="line">        self.stacked_widget.addWidget(self.page1_xml)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># page2  change xml label</span></span><br><span class="line">        self.page2_xml = QWidget()</span><br><span class="line"></span><br><span class="line">        self.page2_label1_xml = QLabel(<span class="string">&#x27;xml root:&#x27;</span>, self.page2_xml)</span><br><span class="line">        self.page2_label1_xml.setGeometry(<span class="number">25</span>, <span class="number">20</span>, <span class="number">100</span>, <span class="number">30</span>)  <span class="comment"># 设置输入框1的位置和大小 (x,y, w, h)</span></span><br><span class="line">        self.page2_input_field1_xml = QLineEdit(self.page2_xml)  <span class="comment"># 在窗口里面添加输入框控件</span></span><br><span class="line">        self.page2_input_field1_xml.setPlaceholderText(<span class="string">&quot;输入xml存放地址：./XmlFilePath&quot;</span>)</span><br><span class="line">        self.page2_input_field1_xml.setGeometry(<span class="number">110</span>, <span class="number">25</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.page2_label2_xml = QLabel(<span class="string">&#x27;ori cla:&#x27;</span>, self.page2_xml)</span><br><span class="line">        self.page2_label2_xml.setGeometry(<span class="number">25</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">30</span>)  <span class="comment"># 设置输入框1的位置和大小 (x,y, w, h)</span></span><br><span class="line">        self.page2_input_field2_xml = QLineEdit(self.page2_xml)  <span class="comment"># 在窗口里面添加输入框控件</span></span><br><span class="line">        self.page2_input_field2_xml.setPlaceholderText(<span class="string">&quot;输入需要修改的标签名：car or person...&quot;</span>)</span><br><span class="line">        self.page2_input_field2_xml.setGeometry(<span class="number">110</span>, <span class="number">55</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.page2_label3_xml = QLabel(<span class="string">&#x27;mod cla:&#x27;</span>, self.page2_xml)</span><br><span class="line">        self.page2_label3_xml.setGeometry(<span class="number">25</span>, <span class="number">80</span>, <span class="number">100</span>, <span class="number">30</span>)  <span class="comment"># 设置输入框1的位置和大小 (x,y, w, h)</span></span><br><span class="line">        self.page2_input_field3_xml = QLineEdit(self.page2_xml)  <span class="comment"># 在窗口里面添加输入框控件</span></span><br><span class="line">        self.page2_input_field3_xml.setPlaceholderText(<span class="string">&quot;输入修改后的标签名：car or person...&quot;</span>)</span><br><span class="line">        self.page2_input_field3_xml.setGeometry(<span class="number">110</span>, <span class="number">85</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.page2_label4_xml = QLabel(<span class="string">&#x27;param:&#x27;</span>, self.page2_xml)</span><br><span class="line">        self.page2_label4_xml.setGeometry(<span class="number">25</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">30</span>)  <span class="comment"># 设置输入框1的位置和大小 (x,y, w, h)</span></span><br><span class="line">        self.page2_input_field4_xml = QLineEdit(self.page2_xml)  <span class="comment"># 在窗口里面添加输入框控件</span></span><br><span class="line">        self.page2_input_field4_xml.setPlaceholderText(<span class="string">&quot;是否执行不为ori都修改为mod参数：0(否) or 1（是）&quot;</span>)</span><br><span class="line">        self.page2_input_field4_xml.setGeometry(<span class="number">110</span>, <span class="number">115</span>, <span class="number">330</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.page2_submit_button_xml = QPushButton(<span class="string">&quot;运行&quot;</span>, self.page2_xml)  <span class="comment"># 在窗口里面添加按钮控件</span></span><br><span class="line">        self.page2_submit_button_xml.setGeometry(<span class="number">250</span>, <span class="number">200</span>, <span class="number">70</span>, <span class="number">30</span>)</span><br><span class="line">        self.page2_submit_button_xml.clicked.connect(self.change_xml_label_button_click)</span><br><span class="line"></span><br><span class="line">        self.stacked_widget.addWidget(self.page2_xml)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ----------方法----------</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_combobox</span>(<span class="params">self, custom_param</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.combobox_txt.isHidden():</span><br><span class="line">            self.combobox_txt.show()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.combobox_txt.hide()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># -----下拉选项触发-----</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">switch_page</span>(<span class="params">self, combobox, stacked_widget</span>):</span></span><br><span class="line">        index = combobox.currentIndex()</span><br><span class="line">        stacked_widget.setCurrentIndex(index)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">xml2txt_button_click</span>(<span class="params">self</span>):</span></span><br><span class="line">        img_root = self.page1_input_field1_xml.text()  <span class="comment"># 标注图片路径</span></span><br><span class="line">        xml_root = self.page1_input_field2_xml.text()  <span class="comment"># xml地址</span></span><br><span class="line">        input_classes = self.page1_input_field3_xml.text()  <span class="comment"># classes列表</span></span><br><span class="line">        classes = input_classes[<span class="number">1</span>:-<span class="number">1</span>].split(<span class="string">&#x27;, &#x27;</span>)  <span class="comment"># 获取为str类型数据，转为list</span></span><br><span class="line">        txt_root = self.page1_input_field4_xml.text()  <span class="comment"># txt保存地址</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">for</span> xml_name <span class="keyword">in</span> os.listdir(xml_root):</span><br><span class="line">                <span class="built_in">print</span>(xml_name)</span><br><span class="line">                txt_save_path = os.path.join(txt_root, xml_name.replace(<span class="string">&#x27;xml&#x27;</span>, <span class="string">&#x27;txt&#x27;</span>))</span><br><span class="line">                xml2txt(xml_root, xml_name, txt_save_path, classes, img_root)</span><br><span class="line">            <span class="comment"># 成功运行提示</span></span><br><span class="line">            QMessageBox.information(self, <span class="string">&#x27;Success&#x27;</span>, <span class="string">&#x27;Your program has run successfully!&#x27;</span>, QMessageBox.Ok)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 捕获异常并显示错误消息</span></span><br><span class="line">            QMessageBox.critical(self, <span class="string">&#x27;Error&#x27;</span>, <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># self.page1_input_field1_xml.clear()</span></span><br><span class="line">            <span class="comment"># self.page1_input_field2_xml.clear()</span></span><br><span class="line">            <span class="comment"># self.page1_input_field3_xml.clear()</span></span><br><span class="line">            <span class="comment"># self.page1_input_field4_xml.clear()</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">change_xml_label_button_click</span>(<span class="params">self</span>):</span></span><br><span class="line">        xml_root = self.page2_input_field1_xml.text()</span><br><span class="line">        origin = self.page2_input_field2_xml.text()</span><br><span class="line">        modify = self.page2_input_field3_xml.text()</span><br><span class="line">        input_param = self.page2_input_field4_xml.text()</span><br><span class="line">        <span class="keyword">if</span> input_param == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            reverse_param = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            reverse_param = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            change_xml_label(xml_root, origin, modify, reverse_param)</span><br><span class="line">            <span class="comment"># 成功运行</span></span><br><span class="line">            QMessageBox.information(self, <span class="string">&#x27;Success&#x27;</span>, <span class="string">&#x27;Your program has run successfully!&#x27;</span>, QMessageBox.Ok)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 捕获异常并显示错误消息</span></span><br><span class="line">            QMessageBox.critical(self, <span class="string">&#x27;Error&#x27;</span>, <span class="string">f&quot;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    window = MyWindow()</span><br><span class="line">    window.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure><hr><h2><span id="界面展示">界面展示：</span></h2><p>下拉框可选择2个功能，存在2个切换界面，根据输入框文字提示输入参数格式，点击运行，运行成功返回成功提示，运行失败返回失败提示。</p><p><img src="%E7%95%8C%E9%9D%A2%E5%B1%95%E7%A4%BA.png" alt="主界面"></p><p><img src="%E8%BF%90%E8%A1%8C%E6%88%90%E5%8A%9F%E6%8F%90%E7%A4%BA.png" alt="成功提示"></p><p><img src="%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA.png" alt="错误提示"></p><h2><span id="版本历史">版本历史</span></h2><ul><li><strong>2024-02-25</strong>： 初版文档</li><li><strong>2025-01-06</strong>：完善文档结构</li></ul>]]></content>
      
      
      <categories>
          
          <category> Engineering </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PyQt </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyQt入门1</title>
      <link href="/2024/02/20/PyQt%E5%85%A5%E9%97%A81/"/>
      <url>/2024/02/20/PyQt%E5%85%A5%E9%97%A81/</url>
      
        <content type="html"><![CDATA[<h2><span id="pyqt入门1">PyQt入门1</span></h2><blockquote><p>针对工作中存在的重复性流程，将核心功能进行可视化封装，通过界面化引导执行并打包为独立的可执行程序（exe），便于快速上手、一键操作</p></blockquote><h2><span id="目录">目录</span></h2><p><a href="#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85">环境安装</a></p><p><a href="#%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8">实际使用</a></p><ul><li><a href="#Step1%E3%80%81%E7%AA%97%E5%8F%A3%E6%9E%84%E5%BB%BA">窗口构建</a></li><li><a href="#Step2%E3%80%81%E7%AE%80%E5%8D%95%E5%BA%94%E7%94%A8">简单应用</a></li><li><a href="#Step3%E3%80%81%E6%89%93%E5%8C%85exe">打包exe</a></li></ul><p><a href="#%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95">问题记录</a></p><h2><span id="环境安装">环境安装：</span></h2><p>windows：直接pip安装即可，使用百度镜像安装命令如下，此处pyinstaller模块用来将python代码打包成exe。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://mirrors.baidu.com/pypi/simple PyQt5 pyinstaller</span><br></pre></td></tr></table></figure><hr><h2><span id="实际使用">实际使用：</span></h2><h3><span id="step1-窗口构建">Step1、窗口构建</span></h3><p><strong>常见控件：</strong>QLabel（文本控件）、QLineEdit（输入框）、QPushButoon（按钮）、按钮触发功能实现。</p><p>以QLabel控件为例：可插入文字、图片，也可将QLabel控件插入到QLabel中叠加使用。</p><ul><li><strong>创建方式：</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加文字</span></span><br><span class="line"><span class="comment"># 方式一</span></span><br><span class="line">label = QLabel(text)    <span class="comment"># text为要添加的文本</span></span><br><span class="line"><span class="comment">#方式二</span></span><br><span class="line">label = QLabel()</span><br><span class="line">label.setText(<span class="string">&quot;This is a QLabel&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加图片</span></span><br><span class="line">img_label = QLabel() </span><br><span class="line">pixmap = QPixmap(img_path)</span><br><span class="line">img_label.setPixmap(pixmap)</span><br></pre></td></tr></table></figure><ul><li><strong>自定义位置、大小：</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方式一</span></span><br><span class="line">qlabel = QLabel()</span><br><span class="line">qlabel.move(x, y)</span><br><span class="line">qlabel.resize(w, h)</span><br><span class="line"><span class="comment">#方式二</span></span><br><span class="line">qlabel.setGeometry(x, y, w, h)</span><br></pre></td></tr></table></figure><ul><li><strong>调整控件样式：setStyleSheet</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义位置</span></span><br><span class="line"><span class="comment"># padding-left表示到左边的距离，padding-top到顶部的距离</span></span><br><span class="line">label.setStyleSheet(<span class="string">&quot;padding-left:10px; border-radius: 10px;background-color: white;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 固定左对齐、居中等</span></span><br><span class="line"><span class="comment"># 设置文本位置，将文本水平和垂直居中对齐</span></span><br><span class="line">label.setAlignment(Qt.AlignHCenter | Qt.AlignVCenter)</span><br></pre></td></tr></table></figure><ul><li><strong>叠加使用：（QLabel包含Qlabel）</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QWidget, QLabel, QScrollArea</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个滚动区域</span></span><br><span class="line">    scroll_area = QScrollArea()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个 QWidget 作为滚动区域的内容</span></span><br><span class="line">    container = QWidget(scroll_area)</span><br><span class="line"></span><br><span class="line">    not_other_num = <span class="number">0</span>  <span class="comment"># 父 QLabel 的数量计数器</span></span><br><span class="line">    y_offset = <span class="number">0</span>  <span class="comment"># 控制纵向位置的偏移量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):  <span class="comment"># 示例循环 5 次</span></span><br><span class="line">        <span class="comment"># 创建父级 QLabel</span></span><br><span class="line">        parent_label = QLabel(container)</span><br><span class="line">        parent_label.setGeometry(<span class="number">0</span>, y_offset, <span class="number">200</span>, <span class="number">50</span>)  <span class="comment"># 设置父级 QLabel 的位置和大小</span></span><br><span class="line">        parent_label.setStyleSheet(<span class="string">&quot;background-color: yellow;&quot;</span>)  <span class="comment"># 设置父级 QLabel 的背景颜色</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建两个包含文字的 QLabel</span></span><br><span class="line">        label1 = QLabel(<span class="string">&quot;Label 1&quot;</span>, parent=parent_label)</span><br><span class="line">        label1.setGeometry(<span class="number">10</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">30</span>)  <span class="comment"># 设置第一个 QLabel 的位置和大小</span></span><br><span class="line">        label1.setStyleSheet(<span class="string">&quot;background-color: red&quot;</span>)  <span class="comment"># 设置第一个 QLabel 的背景颜色</span></span><br><span class="line"></span><br><span class="line">        label2 = QLabel(<span class="string">&quot;Label 2&quot;</span>, parent=parent_label)</span><br><span class="line">        label2.setGeometry(<span class="number">100</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">30</span>)  <span class="comment"># 设置第二个 QLabel 的位置和大小</span></span><br><span class="line">        label2.setStyleSheet(<span class="string">&quot;background-color: blue&quot;</span>)  <span class="comment"># 设置第二个 QLabel 的背景颜色</span></span><br><span class="line"></span><br><span class="line">        not_other_num += <span class="number">1</span></span><br><span class="line">        y_offset += <span class="number">60</span>  <span class="comment"># 更新纵向位置偏移量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置容器的固定大小</span></span><br><span class="line">    container.setFixedSize(<span class="number">200</span>, y_offset)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将容器设置为滚动区域的 widget</span></span><br><span class="line">    scroll_area.setWidget(container)</span><br><span class="line"></span><br><span class="line">    scroll_area.show()</span><br><span class="line"></span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure><p><strong>实现</strong>：将父级QLabel添加到一个Widget()中，然后将Widget存放到滚动区域QScrollArea里</p><blockquote><p>！！！注意：当自定义设置QScrollArea大小时，QWidget大小必须大于QScrollArea大小，才能有效实现结果。</p></blockquote><h3><span id="step2-简单应用">Step2、简单应用</span></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QWidget, QPushButton, QLabel, QVBoxLayout, QLineEdit</span><br><span class="line"><span class="keyword">from</span> utils.excel_utils <span class="keyword">import</span> numberAndCount  <span class="comment"># 个人功能函数，替换</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWindow</span>(<span class="params">QWidget</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建界面</span></span><br><span class="line">        self.setWindowTitle(<span class="string">&#x27;测试平台&#x27;</span>)  <span class="comment"># 界面名称</span></span><br><span class="line">        self.resize(<span class="number">640</span>,<span class="number">480</span>)</span><br><span class="line">        <span class="comment"># self.setGeometry(100, 100, 640, 480)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在窗口里面添加label控件</span></span><br><span class="line">        self.label1 = QLabel(<span class="string">&#x27;Path1:&#x27;</span>, self)</span><br><span class="line">        self.label1.setGeometry(<span class="number">20</span>, <span class="number">20</span>, <span class="number">100</span>, <span class="number">30</span>)  <span class="comment"># 设置文本框的位置和大小 (x,y, w, h)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在窗口里面添加输入框控件</span></span><br><span class="line">        self.input_field1 = QLineEdit(self)</span><br><span class="line">        self.input_field1.setPlaceholderText(<span class="string">&quot;输入统计地址：./tmp_data&quot;</span>)  <span class="comment"># 在输入框中添加提示</span></span><br><span class="line">        self.input_field1.setGeometry(<span class="number">90</span>, <span class="number">25</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        self.label2 = QLabel(<span class="string">&#x27;Path2:&#x27;</span>, self)</span><br><span class="line">        self.label2.setGeometry(<span class="number">20</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">30</span>)  <span class="comment"># (x,y, h, w)</span></span><br><span class="line">        self.input_field2 = QLineEdit(self)  <span class="comment"># 创建</span></span><br><span class="line">        self.input_field2.setPlaceholderText(<span class="string">&quot;输入excel保存地址：./tmp.xlsx&quot;</span>) <span class="comment"># 在输入框中添加提示</span></span><br><span class="line">        self.input_field2.setGeometry(<span class="number">90</span>, <span class="number">55</span>, <span class="number">300</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在窗口里面添加按钮控件</span></span><br><span class="line">        self.submit_button = QPushButton(<span class="string">&quot;运行&quot;</span>, self)</span><br><span class="line">        self.submit_button.setGeometry(<span class="number">50</span>, <span class="number">100</span>, <span class="number">70</span>, <span class="number">30</span>)</span><br><span class="line">        self.submit_button.clicked.connect(self.on_button_click)  <span class="comment"># 按钮触发</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_button_click</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 函数调用，替换成自己的函数</span></span><br><span class="line">        <span class="comment"># train_path_root = &quot;./tmp_data&quot;</span></span><br><span class="line">        <span class="comment"># excel_save_path = &quot;./tmp.xlsx&quot;</span></span><br><span class="line">        train_path_root = self.input_field1.text()</span><br><span class="line">        excel_save_path = self.input_field2.text()</span><br><span class="line">        numberAndCount(train_path_root, excel_save_path)</span><br><span class="line">       </span><br><span class="line">        </span><br><span class="line"><span class="comment"># 主程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    window = MyWindow()  <span class="comment"># 继承QWidget类</span></span><br><span class="line">    window.show()    <span class="comment"># 界面显示</span></span><br><span class="line">    sys.exit(app.exec_())  <span class="comment"># 循环显示界面</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可视化界面如下：</p><p><img src="blog/source/_posts/可视化界面.png"></p><h3><span id="step3-打包exe">Step3、打包exe</span></h3><p>在目标目录打开终端，使用python的pyinstaller对.py文件进行打包，如果打包的程序是图形界面程序，添加-w，则打包后打开exe文件将只出现图形界面，命令行窗口将被隐藏。命令如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller -w .py文件</span><br></pre></td></tr></table></figure><p>将在该目录下生成dist文件和.spec，exe在dist文件下。</p><hr><h2><span id="问题记录">问题记录：</span></h2><p>主要出现在打包的时候：</p><p>问题1、打包时出现RecursionError: maximum recursion depth exceeded错误，网上搜索表示程序中包含递归函数，但经过检查后代码中并不存在.</p><p>解决：<strong>重新安装pyinstaller后解决</strong>。</p><p>问题2、使用conda环境打包时，打包后的exe文件打开后提示无法引用PyQt5。</p><p>解决：<strong>使用 –path 将pyqt5的runw.exe地址手动传入。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller --path=d:\software\Anaconda3\envs\pytorch\Lib\site-packages\PyInstal ler\bootloader\Windows-64bit-intel\runw.exe -w pyqt.py</span><br></pre></td></tr></table></figure><hr><h2><span id="版本历史">版本历史</span></h2><ul><li><strong>2024-02-20</strong>：完成文档初版</li><li><strong>2024-05-05</strong>：完善文档格式及结构，添加目录</li></ul>]]></content>
      
      
      <categories>
          
          <category> Engineering </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PyQt </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyTorch设置随机数</title>
      <link href="/2024/01/19/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E2%80%94%E2%80%94pytorch%E8%AE%BE%E7%BD%AE%E9%9A%8F%E6%9C%BA%E6%95%B0/"/>
      <url>/2024/01/19/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E2%80%94%E2%80%94pytorch%E8%AE%BE%E7%BD%AE%E9%9A%8F%E6%9C%BA%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h2><span id="pytorch设置随机数">PyTorch设置随机数</span></h2><blockquote><p>通过设置随机种子，使训练结果可复现，有效对比模型测试结果；</p></blockquote><h2><span id="目录">目录</span></h2><p>[设置方式](# 设置方式)</p><p><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></p><hr><h2><span id="设置方式">设置方式：</span></h2><p>训练过程中的随机数包含：初始权重、随机数据增强、数据读取顺序等，将这些随机数固定，按理可保证训练结果一致。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置随机种子</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_seed</span>(<span class="params">seed</span>):</span></span><br><span class="line">    random.seed(seed)</span><br><span class="line">    np.random.seed(seed)</span><br><span class="line">    torch.manual_seed(seed)</span><br><span class="line">    torch.cuda.manual_seed(seed)</span><br><span class="line">    torch.cuda.manual_seed_all(seed)</span><br><span class="line">    torch.backends.cudnn.deterministic = <span class="literal">True</span>   </span><br><span class="line">    torch.backends.cudnn.benchmark = <span class="literal">False</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Dataloader的种子</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_random_Dataloader</span>(<span class="params">worker_id, rank, seed</span>):</span></span><br><span class="line">    worker_seed = rank + seed</span><br><span class="line">    random.seed(worker_seed)</span><br><span class="line">    np.random.seed(worker_seed)</span><br><span class="line">    torch.manual_seed(worker_seed)</span><br><span class="line"></span><br><span class="line">set_seed(<span class="number">30</span>)</span><br><span class="line">set_random_Dataloader()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预处理、训练模型</span></span><br></pre></td></tr></table></figure><hr><h2><span id="参考资料">参考资料：</span></h2><ul><li><a href="https://blog.csdn.net/weixin_44791964/article/details/131622957">https://blog.csdn.net/weixin_44791964/article/details/131622957</a></li></ul><hr><h2><span id="版本历史">版本历史</span></h2><ul><li><strong>2024-01-19</strong>: 初版文档</li></ul>]]></content>
      
      
      <categories>
          
          <category> Deep-Learning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PyTorch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023-AI事件回顾</title>
      <link href="/2024/01/09/2023-AI%E4%BA%8B%E4%BB%B6%E5%9B%9E%E9%A1%BE/"/>
      <url>/2024/01/09/2023-AI%E4%BA%8B%E4%BB%B6%E5%9B%9E%E9%A1%BE/</url>
      
        <content type="html"><![CDATA[<p>基础：22年11月30日，ChatGPT横空出世</p><p>23年2月：</p><ol><li>ChatGPT plus 版本上线；</li><li>微软宣布将ChatGPT功能集成到New Bing；</li><li>Meta发布LLaMa</li></ol><p>23年3月：</p><ol><li>OpenAI推出ChatGPT API；</li><li>OpenAI发布GPT-4</li><li>百度发布文心一言</li></ol><p>23年4月： </p><ol><li>Meta发布Segment Anything</li></ol><p>23年5月：</p><ol><li>特斯拉人形机器人（流畅行走、抓取物体）</li></ol><p>===============</p><p>23年6月：</p><ol><li>Runway Gen-2</li></ol><p>23年7月：</p><ol><li>Llama2开源；</li><li> overflow AI</li></ol><p>23年9月：</p><ol><li>OpenAI将DALL.E 1升级至DALL.E 3；</li><li>微软 EvoDiff；</li><li>HeyGen；</li><li>特斯拉Optimus可自主对物体进行分类（端到端训练）。</li></ol><p>23年10月：</p><ol><li>文心大模型4.0发布</li></ol><p>23年11月：</p><ol><li>Pika 1.0发布</li></ol><p>23年12月：</p><ol><li>谷歌DeepMind发布Gemini模型；</li><li>Mixtral AI开源了一个Mixtral 8x7B MoE模型；</li><li>MidJounery V6发布</li></ol><p>整体领域：AIGC</p><p>细分方向：图像生成（Midjourney、DALL-E3、Shutterstock AI）、视频生成（HeyGen、Runway Gen-2、Pika）、文本生成（Gemini、overflowAI、Llama、GPT-4）、图像分割（SAM）</p><p>发展：</p><ol><li>图像生成：GAN&rarr;DiffusionModel（扩散模型）&rarr;stable Diffusion（文本生成图像）</li><li>文本生成：RNN&rarr;Transformer&rarr;GPT</li></ol><p>应用：</p><p><img src="aigc.png" alt="应用："></p><p>图片来源：TE智库《企业AIGC商业落地应用研究报告》</p>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI资讯 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
